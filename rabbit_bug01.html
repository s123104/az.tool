<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯æ„›å…”å…”æ’ç­è¡¨</title>
    <link rel="icon" href="https://s123104.github.io/az.tool/img/magician-hat.png">
    <style>
        body, html {
            font-family: 'Arial', sans-serif;
            background-color: #fff0f5;
            color: #ff69b4;
            margin: 0;
            padding: 0;
            height: 100%;
            font-size: 12px;
            overflow: hidden;
        }

        .calendar-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background-color: #ffebee;
        }

        .header {
            text-align: center;
            padding: 10px;
            background-color: #ff69b4;
            color: white;
            position: relative;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .title img {
            margin-right: 8px; /* æ·»åŠ é–“è· */
            height: 24px; /* èª¿æ•´åœ–ç‰‡é«˜åº¦ */
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .nav-button {
            background-color: #ff1493;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
        }

        .nav-button:hover {
            background-color: #ff69b4;
        }

        .add-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff1493;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 20px;
            cursor: pointer;
        }

        .add-button:hover {
            background-color: #ff69b4;
        }

        .week-view {
            display: flex;
            flex-grow: 1;
        }

        .time-scale {
            position: relative;
            width: 50px;
            background-color: #ffd1dc;
            font-size: 8px;
            text-align: right;
            border-right: 1px solid #ff69b4;
            padding-top: 50px; /* ç¢ºä¿æ™‚é–“åˆ»åº¦çš„åˆå§‹ä½ç½®èˆ‡ day-header çš„ä¸‹é‚Šç·£å°é½Š */
        }

        .time-slot {
            position: absolute;
            right: 2px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            white-space: nowrap;
        }

        .week-grid {
            display: flex;
            flex-grow: 1;
        }

        .day-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ff69b4;
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            text-align: center;
            padding: 5px 0;
            font-weight: bold;
            background-color: #ffd1dc;
            border-bottom: 1px solid #ff69b4;
        }

        .day-content {
            flex-grow: 1;
            position: relative;
        }

        .schedule-item {
            position: absolute;
            left: 2px;
            right: 2px;
            background-color: #ff69b4;
            color: white;
            font-size: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            border-radius: 3px;
            padding: 2px;
            text-align: center;
            cursor: pointer;
        }

        .schedule-item .delete-btn {
            font-size: 10px;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
        }

        .vertical-line {
            display: inline-block;
            width: 1px;
            height: 8px;
            background-color: white;
            margin: 2px 0;
        }

        .total-hours {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            background-color: #ff69b4;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        label {
            display: block;
            margin: 10px 0 5px;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"] {
            width: calc(100% - 10px);
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button[type="submit"] {
            background-color: #ff1493;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }

        button[type="submit"]:hover {
            background-color: #ff69b4;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
        }

        .autocomplete-items div {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #d4d4d4;
        }

        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }

        .autocomplete-active {
            background-color: DodgerBlue !important;
            color: #ffffff;
        }

        .delete-btn {
            background: url('https://s123104.github.io/az.tool/img/trash.png') no-repeat center center;
            background-size: contain;
            border: none;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
<div class="calendar-container">
    <div class="header">
        <h1 class="title">
            <img src="https://s123104.github.io/az.tool/img/magician-hat.png" alt="magician hat">
            å¯æ„›å…”å…”æ’ç­è¡¨
        </h1>
        <button class="add-button" id="addButton">+</button>
        <div class="navigation">
            <button class="nav-button" id="prevWeek">ä¸Šä¸€é€±</button>
            <button class="nav-button" id="nextWeek">ä¸‹ä¸€é€±</button>
        </div>
    </div>
    <div class="week-view">
        <div class="time-scale"></div>
        <div class="week-grid">
            <!-- é€™äº›å…§å®¹ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>
    <div class="total-hours" id="totalHours">æœ¬é€±ç¸½å·¥æ™‚ï¼š0å°æ™‚</div>
</div>

<!-- æ–°å¢å·¥ä½œæ¨¡æ…‹æ¡† -->
<div id="modal-add" class="modal">
    <div class="modal-content">
        <span class="close" id="closeAdd">&times;</span>
        <h2>æ–°å¢å·¥ä½œ</h2>
        <form id="addForm" autocomplete="off">
            <label for="addJobName">å·¥ä½œåç¨±</label>
            <input type="text" id="addJobName" name="addJobName" maxlength="4" required>
            <label for="addJobDate">æ—¥æœŸ</label>
            <input type="date" id="addJobDate" name="addJobDate" required>
            <label for="addStartTime">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="addStartTime" name="addStartTime" required step="600">
            <label for="addEndTime">çµæŸæ™‚é–“</label>
            <input type="time" id="addEndTime" name="addEndTime" required step="600">
            <button type="submit">ä¿å­˜</button>
        </form>
    </div>
</div>

<!-- ä¿®æ”¹å·¥ä½œæ¨¡æ…‹æ¡† -->
<div id="modal-edit" class="modal">
    <div class="modal-content">
        <span class="close" id="closeEdit">&times;</span>
        <h2>ä¿®æ”¹å·¥ä½œ</h2>
        <form id="editForm" autocomplete="off">
            <label for="editJobName">å·¥ä½œåç¨±</label>
            <input type="text" id="editJobName" name="editJobName" maxlength="4" required>
            <label for="editJobDate">æ—¥æœŸ</label>
            <input type="date" id="editJobDate" name="editJobDate" required>
            <label for="editStartTime">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="editStartTime" name="editStartTime" required step="600">
            <label for="editEndTime">çµæŸæ™‚é–“</label>
            <input type="time" id="editEndTime" name="editEndTime" required step="600">
            <button type="submit">ä¿å­˜</button>
        </form>
        <button class="delete-btn" id="deleteBtn">åˆªé™¤</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    const totalHoursElement = document.getElementById('totalHours');
    const addButton = document.getElementById('addButton');
    const modalAdd = document.getElementById('modal-add');
    const modalEdit = document.getElementById('modal-edit');
    const closeAddBtn = document.getElementById('closeAdd');
    const closeEditBtn = document.getElementById('closeEdit');
    const addForm = document.getElementById('addForm');
    const editForm = document.getElementById('editForm');
    const jobNameInputAdd = document.getElementById('addJobName');
    const jobNameInputEdit = document.getElementById('editJobName');
    const deleteBtn = document.getElementById('deleteBtn');

    let currentWeek = new Date();
    let schedules = JSON.parse(localStorage.getItem('schedules')) || {};
    let jobNames = JSON.parse(localStorage.getItem('jobNames')) || [];
    let currentEditKey = null;

    // é è¨­çš„å·¥ä½œå…§å®¹
    const defaultSchedules = {
        "2024-07-16": { jobName: "ç™¾è²¨", start: "16:00", end: "22:00", color: "#ff69b4" },
        "2024-07-18": { jobName: "ç™¾è²¨", start: "16:00", end: "22:00", color: "#ff69b4" },
        "2024-07-20": { jobName: "ç™¾è²¨", start: "14:30", end: "22:00", color: "#ff69b4" },
        "2024-07-23": { jobName: "ç™¾è²¨", start: "10:30", end: "16:30", color: "#ff69b4" },
        "2024-07-24": { jobName: "ç™¾è²¨", start: "14:30", end: "20:30", color: "#ff69b4" }
    };

    // å°‡é è¨­å·¥ä½œå…§å®¹åˆä½µåˆ°schedulesä¸­
    schedules = { ...defaultSchedules, ...schedules };

    function updateWeek(direction) {
        currentWeek.setDate(currentWeek.getDate() + direction * 7);
        generateWeekGrid();
        updateDates();
        updateSchedule();
        updateTotalHours();
        updateTimeScale(); // æ›´æ–°æ™‚é–“åˆ»åº¦
    }

    function generateWeekGrid() {
        const weekGrid = document.querySelector('.week-grid');
        weekGrid.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å…§å®¹
        for (let i = 0; i < 7; i++) {
            const dayColumn = document.createElement('div');
            dayColumn.classList.add('day-column');

            const dayHeader = document.createElement('div');
            dayHeader.classList.add('day-header');
            dayHeader.innerHTML = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'][i] + '<br>';
            dayColumn.appendChild(dayHeader);

            const dayContent = document.createElement('div');
            dayContent.classList.add('day-content');
            dayColumn.appendChild(dayContent);

            weekGrid.appendChild(dayColumn);
        }
    }

    function updateDates() {
        const dayHeaders = document.querySelectorAll('.day-header');
        for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeek);
            date.setDate(date.getDate() - date.getDay() + i + 1);
            dayHeaders[i].innerHTML += `${date.getMonth() + 1}/${date.getDate()}`;
        }
    }

    function updateSchedule() {
        const dayContents = document.querySelectorAll('.day-content');
        dayContents.forEach(content => content.innerHTML = ''); // æ¸…ç©ºåŸæœ‰å…§å®¹

        const firstDayContentHeight = dayContents[0].offsetHeight;
        const totalMinutesInDay = 17 * 60; // 17 å°æ™‚

        Object.keys(schedules).forEach(dateKey => {
            const { jobName, start, end, color } = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            const weekStartDate = new Date(currentWeek);
            weekStartDate.setDate(weekStartDate.getDate() - weekStartDate.getDay() + 1);

            if (scheduleDate >= weekStartDate && scheduleDate < new Date(weekStartDate.getTime() + 7 * 24 * 60 * 60 * 1000)) {
                const dayIndex = (scheduleDate.getDay() + 6) % 7;
                const startTime = parseTime(start);
                const endTime = parseTime(end);
                const duration = (endTime - startTime) / 3600000; // è½‰æ›ç‚ºå°æ™‚
                const topPosition = ((startTime.getHours() - 7) * 60 + startTime.getMinutes()) / totalMinutesInDay * firstDayContentHeight; // å‡è¨­æ—©ä¸Š7é»é–‹å§‹
                const height = (duration * 60) / totalMinutesInDay * firstDayContentHeight; // 17å°æ™‚çš„ä¸€å¤©
                const scheduleItem = document.createElement('div');
                scheduleItem.classList.add('schedule-item');
                scheduleItem.style.top = `${topPosition}px`;
                scheduleItem.style.height = `${height}px`;
                scheduleItem.style.backgroundColor = color;
                scheduleItem.innerHTML = `ğŸ°<br>${jobName}<br>${formatTime(start)}<br><span class="vertical-line"></span><br>${formatTime(end)}`;

                const content = dayContents[dayIndex];
                content.appendChild(scheduleItem);

                scheduleItem.addEventListener('click', () => openEditModal(dateKey));
            }
        });
    }

    function updateTotalHours() {
        let totalHours = 0;
        const weekStartDate = new Date(currentWeek);
        weekStartDate.setDate(weekStartDate.getDate() - weekStartDate.getDay() + 1);
        const weekEndDate = new Date(weekStartDate.getTime() + 7 * 24 * 60 * 60 * 1000);

        Object.keys(schedules).forEach(dateKey => {
            const scheduleDate = new Date(dateKey);
            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
                const { start, end } = schedules[dateKey];
                totalHours += (parseTime(end) - parseTime(start)) / 3600000; // è½‰æ›ç‚ºå°æ™‚
            }
        });
        totalHoursElement.textContent = `æœ¬é€±ç¸½å·¥æ™‚ï¼š${totalHours.toFixed(1)}å°æ™‚`;
    }

    function parseTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return new Date(0, 0, 0, hours, minutes);
    }

    function formatTime(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const period = hours < 12 ? 'æ—©ä¸Š' : hours < 18 ? 'ä¸‹åˆ' : 'æ™šä¸Š';
        const formattedHours = hours % 12 || 12;
        return `${period} ${formattedHours}:${minutes.toString().padStart(2, '0')}`;
    }

    function generateColor(jobName) {
        const colors = ['#ffc0cb', '#ffb6c1', '#ff69b4', '#ff1493', '#db7093', '#ff8c69', '#ff6347', '#ff4500'];
        const jobType = jobName.charCodeAt(0) % colors.length;
        return colors[jobType];
    }

    function openAddModal() {
        modalAdd.style.display = 'block';
    }

    function closeAddModal() {
        modalAdd.style.display = 'none';
    }

    function openEditModal(dateKey) {
        const { jobName, start, end } = schedules[dateKey];
        currentEditKey = dateKey;
        document.getElementById('editJobName').value = jobName;
        document.getElementById('editJobDate').value = dateKey;
        document.getElementById('editStartTime').value = start;
        document.getElementById('editEndTime').value = end;
        modalEdit.style.display = 'block';
    }

    function closeEditModal() {
        modalEdit.style.display = 'none';
    }

    function deleteSchedule() {
        delete schedules[currentEditKey];
        localStorage.setItem('schedules', JSON.stringify(schedules));
        closeEditModal();
        updateSchedule();
        updateTotalHours();
    }

    function saveAddSchedule() {
        const jobName = document.getElementById('addJobName').value;
        const jobDate = document.getElementById('addJobDate').value;
        const startTime = document.getElementById('addStartTime').value;
        const endTime = document.getElementById('addEndTime').value;
        const color = generateColor(jobName);

        schedules[jobDate] = { jobName, start: startTime, end: endTime, color };
        localStorage.setItem('schedules', JSON.stringify(schedules));
        if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem('jobNames', JSON.stringify(jobNames));
        }
        closeAddModal();
        updateSchedule();
        updateTotalHours();
    }

    function saveEditSchedule() {
        const jobName = document.getElementById('editJobName').value;
        const jobDate = document.getElementById('editJobDate').value;
        const startTime = document.getElementById('editStartTime').value;
        const endTime = document.getElementById('editEndTime').value;
        const color = generateColor(jobName);

        delete schedules[currentEditKey];
        schedules[jobDate] = { jobName, start: startTime, end: endTime, color };
        localStorage.setItem('schedules', JSON.stringify(schedules));
        if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem('jobNames', JSON.stringify(jobNames));
        }
        closeEditModal();
        updateSchedule();
        updateTotalHours();
    }

    function autocomplete(inp, arr) {
        let currentFocus;
        inp.addEventListener("input", function(e) {
            let a, b, i, val = this.value;
            closeAllLists();
            if (!val) { return false;}
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            for (i = 0; i < arr.length; i++) {
                if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                    b = document.createElement("DIV");
                    b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                    b.innerHTML += arr[i].substr(val.length);
                    b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                    b.addEventListener("click", function(e) {
                        inp.value = this.getElementsByTagName("input")[0].value;
                        closeAllLists();
                    });
                    a.appendChild(b);
                }
            }
        });
        inp.addEventListener("keydown", function(e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) {
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) {
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                }
            }
        });
        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }
        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }
        function closeAllLists(elmnt) {
            let x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
                if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                }
            }
        }
        document.addEventListener("click", function (e) {
            closeAllLists(e.target);
        });
    }

    addButton.addEventListener('click', () => {
        openAddModal();
    });

    closeAddBtn.addEventListener('click', closeAddModal);
    closeEditBtn.addEventListener('click', closeEditModal);
    deleteBtn.addEventListener('click', deleteSchedule);

    window.addEventListener('click', (event) => {
        if (event.target == modalAdd) {
            closeAddModal();
        }
        if (event.target == modalEdit) {
            closeEditModal();
        }
    });

    prevWeekBtn.addEventListener('click', () => updateWeek(-1));
    nextWeekBtn.addEventListener('click', () => updateWeek(1));

    addForm.addEventListener('submit', (e) => {
        e.preventDefault();
        saveAddSchedule();
    });

    editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        saveEditSchedule();
    });

    function updateTimeScale() {
        const timeScale = document.querySelector('.time-scale');
        timeScale.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å…§å®¹

        const firstDayContentHeight = document.querySelector('.day-content').offsetHeight;
        const totalMinutesInDay = 17 * 60; // 17 å°æ™‚
        const headerHeight = document.querySelector('.day-header').offsetHeight; // ç²å– day-header çš„é«˜åº¦
        const timeIntervals = [
            "æ—©ä¸Š7:00","æ—©ä¸Š8:00", "æ—©ä¸Š9:00", "ä¸Šåˆ10:00", "ä¸Šåˆ11:00", "ä¸­åˆ12:00",
            "ä¸‹åˆ1:00", "ä¸‹åˆ2:00", "ä¸‹åˆ3:00", "ä¸‹åˆ4:00", "ä¸‹åˆ5:00", "æ™šä¸Š6:00",
            "æ™šä¸Š7:00", "æ™šä¸Š8:00", "æ™šä¸Š9:00", "æ™šä¸Š10:00", "æ™šä¸Š11:00", "æ™šä¸Š12:00"
        ];
        timeIntervals.forEach((time, index) => {
            const timeSlot = document.createElement('div');
            timeSlot.classList.add('time-slot');
            const topPosition = (index / (timeIntervals.length - 1)) * (firstDayContentHeight) + headerHeight;
            timeSlot.style.top = `${topPosition}px`;
            timeSlot.innerHTML = time;
            timeScale.appendChild(timeSlot);
        });
    }

    generateWeekGrid();
    updateDates();
    updateSchedule();
    updateTotalHours();
    updateTimeScale(); // åˆå§‹åŒ–æ™‚é–“åˆ»åº¦
    autocomplete(jobNameInputAdd, jobNames);
    autocomplete(jobNameInputEdit, jobNames);
});
</script>
</body>
</html>