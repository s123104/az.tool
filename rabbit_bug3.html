<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>å¯æ„›å…”å…”æ’ç­è¡¨</title>
    <link
      rel="icon"
      href="https://s123104.github.io/az.tool/img/magician-hat.png"
    />
    <style>
      /* åŸºæœ¬æ¨£å¼ */
      body,
      html {
        font-family: "Arial", sans-serif;
        background-color: #fff0f5;
        color: #ff69b4;
        margin: 0;
        padding: 0;
        font-size: 12px;
        height: 100%;
      }

      .calendar-container {
        display: flex;
        flex-direction: column;
        height: 100%; /* ä½¿ç”¨è¦–çª—é«˜åº¦ */
        background-color: #ffebee;
      }

      .header {
        text-align: center;
        padding: 10px;
        background-color: #ff69b4;
        color: white;
        position: relative;
        flex: 0 0 auto;
      }

      .title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .title img {
        margin-right: 8px;
        height: 24px;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
      }

      .nav-button {
        background-color: #ff1493;
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
      }

      .nav-button:hover {
        background-color: #ff69b4;
      }

      .add-button {
        position: absolute;
        top: 5px;
        right: 10px;
        background-color: #ff1493;
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 16px;
        line-height: 16px;
        cursor: pointer;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .add-button:hover {
        background-color: #ff69b4;
      }

      .week-view {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
        flex: 1 1 auto;
      }

      .time-scale {
        position: relative;
        width: 45px;
        background-color: #ffd1dc;
        font-size: 8px;
        text-align: right;
        padding-top: 50px;
        padding-left: 2px;
      }

      .time-slot {
        position: relative;
        height: calc(100% / 17); /* æ¯å€‹æ™‚é–“æ®µä½”1/17çš„é«˜åº¦ */
      }

      .week-grid {
        display: flex;
        flex-grow: 1;
        overflow-y: auto; /* å…è¨±å‚ç›´æ»¾å‹• */
      }

      .day-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #ff69b4;
        position: relative;
      }

      .day-column:last-child {
        border-right: none;
      }

      .day-header {
        text-align: center;
        padding: 5px 0;
        font-weight: bold;
        background-color: #ffd1dc;
        border-bottom: 1px solid #ff69b4;
      }

      .day-content {
        flex-grow: 1;
        position: relative;
        overflow: hidden;
      }

      .schedule-item {
        position: absolute;
        left: 2px;
        right: 2px;
        color: white;
        font-size: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        border-radius: 3px;
        padding: 2px;
        text-align: center;
        cursor: pointer;
      }

      .vertical-line {
        display: inline-block;
        width: 1px;
        height: 8px;
        background-color: white;
        margin: 2px 0;
      }

      .total-hours {
        text-align: center;
        padding: 10px;
        font-weight: bold;
        background-color: #ff69b4;
        color: white;
        flex: 0 0 auto;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 2;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* å…è¨±æ¨¡æ…‹æ¡†å…§éƒ¨æ»¾å‹• */
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }

      .modal-content {
        background-color: #fff;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        width: 90%;
        max-width: 400px;
        border-radius: 10px;
        max-height: 70vh;
        overflow-y: auto; /* å…è¨±å…§å®¹æ»¾å‹• */
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      .toggle-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }

      .toggle-button {
        padding: 5px 15px;
        cursor: pointer;
        text-align: center;
        border-radius: 15px;
        color: white;
        font-size: 14px;
      }

      .toggle-button.single {
        background-color: #ffb6c1;
      }

      .toggle-button.multi {
        background-color: #ffb6c1;
      }

      .toggle-button.command {
        background-color: #ffb6c1;
      }

      .toggle-button.active {
        background-color: #ff1493;
      }

      label {
        display: block;
        margin: 10px 0 5px;
      }

      input[type="text"],
      input[type="date"],
      textarea {
        width: calc(100% - 10px);
        padding: 5px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .time-input-wrapper {
        display: flex;
        align-items: center;
      }

      .time-input-wrapper select {
        width: 45%;
        margin: 5px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .weekdays {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
      }

      .weekday {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #ffb6c1;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
      }

      .weekday.selected {
        background-color: #ff1493;
      }

      button[type="submit"] {
        background-color: #ff1493;
        border: none;
        color: white;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
      }

      button[type="submit"]:hover {
        background-color: #ff69b4;
      }

      .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        max-height: 150px;
        overflow-y: auto;
      }

      .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #d4d4d4;
      }

      .autocomplete-items div:hover {
        background-color: #e9e9e9;
      }

      .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
      }

      .delete-btn {
        background-color: #ff4c4c;
        border: none;
        color: white;
        font-size: 10px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        top: 2px;
        right: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }

      .delete-btn:hover {
        background-color: #ff0000;
      }

      /* æµ®å‹•æç¤ºçª—æ¨£å¼ */
      .toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #ff1493;
        color: white;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        right: 30px;
        bottom: 30px; /* ç§»è‡³åº•éƒ¨ */
        font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .toast.show {
        visibility: visible;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      /* æ‰‹æ©Ÿä»‹é¢èª¿æ•´ */
      @media only screen and (max-width: 600px) {
        .calendar-container {
          padding: 0;
          width: 100%;
        }

        .header {
          padding: 5px;
        }

        .title {
          font-size: 16px;
        }

        .nav-button,
        .add-button {
          padding: 3px 7px;
          font-size: 10px;
        }

        .add-button {
          width: 25px;
          height: 25px;
          line-height: 25px;
          font-size: 14px;
          top: 5px;
        }

        .time-scale {
          font-size: 7px;
          width: 40px;
        }

        .total-hours {
          padding: 5px;
          font-size: 10px;
        }

        .modal-content {
          width: 95%;
          max-width: 300px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        button[type="submit"] {
          padding: 7px;
          margin: 3px 0;
        }

        button[type="submit"] {
          font-size: 14px;
        }

        .schedule-item {
          font-size: 7px;
        }

        .delete-btn {
          width: 12px;
          height: 12px;
          font-size: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="calendar-container">
      <div class="header">
        <h1 class="title">
          <img
            src="https://s123104.github.io/az.tool/img/magician-hat.png"
            alt="magician hat"
          />
          å¯æ„›å…”å…”æ’ç­è¡¨
        </h1>
        <button class="add-button" id="addButton">+</button>
        <div class="navigation">
          <button class="nav-button" id="prevWeek">ä¸Šä¸€é€±</button>
          <button class="nav-button" id="nextWeek">ä¸‹ä¸€é€±</button>
        </div>
      </div>
      <div class="week-view">
        <div class="time-scale" id="timeScale"></div>
        <div class="week-grid">
          <!-- é€™äº›å…§å®¹ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
      <div class="total-hours" id="totalHours">æœ¬é€±ç¸½å·¥æ™‚ï¼š0å°æ™‚</div>
    </div>

    <!-- æ–°å¢å·¥ä½œæ¨¡æ…‹æ¡† -->
    <div id="modal-add" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAdd">&times;</span>
        <div class="toggle-container">
          <div class="toggle-button single active" id="singleAddToggle">
            å–®æ¬¡
          </div>
          <div class="toggle-button multi" id="batchAddToggle">æ‰¹é‡</div>
          <div class="toggle-button command" id="commandToggle">æŒ‡ä»¤</div>
        </div>
        <div id="singleAddContainer">
          <h2>æ–°å¢å·¥ä½œ</h2>
          <form id="addForm" autocomplete="off">
            <label for="addJobName">å·¥ä½œåç¨±</label>
            <input
              type="text"
              id="addJobName"
              name="addJobName"
              maxlength="4"
              required
            />
            <label for="addJobDate">æ—¥æœŸ</label>
            <input type="date" id="addJobDate" name="addJobDate" required />
            <label for="addStartTime">é–‹å§‹æ™‚é–“</label>
            <div class="time-input-wrapper">
              <select id="addStartHour" name="addStartHour" required></select>
              :
              <select
                id="addStartMinute"
                name="addStartMinute"
                required
              ></select>
            </div>
            <label for="addEndTime">çµæŸæ™‚é–“</label>
            <div class="time-input-wrapper">
              <select id="addEndHour" name="addEndHour" required></select>
              :
              <select id="addEndMinute" name="addEndMinute" required></select>
            </div>
            <button type="submit">ä¿å­˜</button>
          </form>
        </div>
        <div id="batchAddContainer" style="display: none">
          <h2>æ‰¹é‡æ–°å¢å·¥ä½œ</h2>
          <form id="batchAddForm" autocomplete="off">
            <label for="batchAddJobName">å·¥ä½œåç¨±</label>
            <input
              type="text"
              id="batchAddJobName"
              name="batchAddJobName"
              maxlength="4"
              required
            />
            <label for="batchAddStartDate">é–‹å§‹æ—¥æœŸ</label>
            <input
              type="date"
              id="batchAddStartDate"
              name="batchAddStartDate"
              required
            />
            <label for="batchAddEndDate">çµæŸæ—¥æœŸ</label>
            <input
              type="date"
              id="batchAddEndDate"
              name="batchAddEndDate"
              required
            />
            <label for="batchAddStartTime">é–‹å§‹æ™‚é–“</label>
            <div class="time-input-wrapper">
              <select
                id="batchAddStartHour"
                name="batchAddStartHour"
                required
              ></select>
              :
              <select
                id="batchAddStartMinute"
                name="batchAddStartMinute"
                required
              ></select>
            </div>
            <label for="batchAddEndTime">çµæŸæ™‚é–“</label>
            <div class="time-input-wrapper">
              <select
                id="batchAddEndHour"
                name="batchAddEndHour"
                required
              ></select>
              :
              <select
                id="batchAddEndMinute"
                name="batchAddEndMinute"
                required
              ></select>
            </div>
            <div class="weekdays">
              <div class="weekday" data-day="1">ä¸€</div>
              <div class="weekday" data-day="2">äºŒ</div>
              <div class="weekday" data-day="3">ä¸‰</div>
              <div class="weekday" data-day="4">å››</div>
              <div class="weekday" data-day="5">äº”</div>
              <div class="weekday" data-day="6">å…­</div>
              <div class="weekday" data-day="0">æ—¥</div>
            </div>
            <button type="submit">æ‰¹é‡ä¿å­˜</button>
          </form>
        </div>
        <div id="commandContainer" style="display: none">
          <h2>æŒ‡ä»¤å¿«é€Ÿæ–°å¢</h2>
          <form id="commandForm" autocomplete="off">
            <label for="commandJobName">å·¥ä½œåç¨±</label>
            <input
              type="text"
              id="commandJobName"
              name="commandJobName"
              maxlength="4"
              required
            />
            <label for="commandInput">è¼¸å…¥æŒ‡ä»¤:</label>
            <textarea
              id="commandInput"
              name="commandInput"
              rows="5"
              required
            ></textarea>
            <details>
              <summary>é»æ­¤æŸ¥çœ‹æŒ‡ä»¤ç¯„ä¾‹</summary>
              <p>æ ¼å¼èªªæ˜:</p>
              <ul>
                <li>å·¥ä½œåç¨±: é€éä¸Šæ–¹ã€Œå·¥ä½œåç¨±ã€æ¬„ä½è¼¸å…¥ã€‚</li>
                <li>
                  æŒ‡ä»¤æ ¼å¼:
                  <ul>
                    <li>
                      å€é–“å…§ä¸æŒ‡å®šæ˜ŸæœŸ:
                      <ul>
                        <li>ç¯„ä¾‹ä¸€:10/10-10/13 12:00-20:30</li>
                        <li>ç¯„ä¾‹äºŒ:10/15~10/18 12.-20.5</li>
                      </ul>
                    </li>
                    <li>
                      å€é–“å…§æŒ‡å®šæ˜ŸæœŸ:
                      <ul>
                        <li>ç¯„ä¾‹ä¸€:10/10-10/13 12:00-20:30(ä¸€,ä¸‰,äº”)</li>
                        <li>ç¯„ä¾‹äºŒ:10/15~10/18 12.-20.5(ä¸€,ä¸‰,äº”)</li>
                      </ul>
                    </li>
                    <li>
                      å–®æ—¥:
                      <ul>
                        <li>ç¯„ä¾‹ä¸€:10/13 12:00-20:30</li>
                        <li>ç¯„ä¾‹äºŒ:10/13 12.-20.5</li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li>ç‰¹æ®Šè¦å‰‡: -~ç‚ºå€é–“ç¬¦è™Ÿ, 12.ç‚º12:00ç°¡å¯«, 12.5ç‚º12:30ç°¡å¯«</li>
              </ul>
            </details>
            <button type="submit">åŸ·è¡ŒæŒ‡ä»¤</button>
          </form>
        </div>
      </div>
    </div>

    <!-- ä¿®æ”¹å·¥ä½œæ¨¡æ…‹æ¡† -->
    <div id="modal-edit" class="modal">
      <div class="modal-content">
        <span class="close" id="closeEdit">&times;</span>
        <h2>ä¿®æ”¹å·¥ä½œ</h2>
        <form id="editForm" autocomplete="off">
          <label for="editJobName">å·¥ä½œåç¨±</label>
          <input
            type="text"
            id="editJobName"
            name="editJobName"
            maxlength="4"
            required
          />
          <label for="editJobDate">æ—¥æœŸ</label>
          <input type="date" id="editJobDate" name="editJobDate" required />
          <label for="editStartTime">é–‹å§‹æ™‚é–“</label>
          <div class="time-input-wrapper">
            <select id="editStartHour" name="editStartHour" required></select>
            :
            <select
              id="editStartMinute"
              name="editStartMinute"
              required
            ></select>
          </div>
          <label for="editEndTime">çµæŸæ™‚é–“</label>
          <div class="time-input-wrapper">
            <select id="editEndHour" name="editEndHour" required></select>
            :
            <select id="editEndMinute" name="editEndMinute" required></select>
          </div>
          <button type="submit">ä¿å­˜</button>
        </form>
      </div>
    </div>

    <!-- æµ®å‹•æç¤ºçª— -->
    <div id="toast" class="toast"></div>

    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        const prevWeekBtn = document.getElementById("prevWeek");
        const nextWeekBtn = document.getElementById("nextWeek");
        const totalHoursElement = document.getElementById("totalHours");
        const addButton = document.getElementById("addButton");
        const modalAdd = document.getElementById("modal-add");
        const modalEdit = document.getElementById("modal-edit");
        const closeAddBtn = document.getElementById("closeAdd");
        const closeEditBtn = document.getElementById("closeEdit");
        const addForm = document.getElementById("addForm");
        const batchAddForm = document.getElementById("batchAddForm");
        const commandForm = document.getElementById("commandForm");
        const singleAddToggle = document.getElementById("singleAddToggle");
        const batchAddToggle = document.getElementById("batchAddToggle");
        const commandToggle = document.getElementById("commandToggle");
        const singleAddContainer =
          document.getElementById("singleAddContainer");
        const batchAddContainer = document.getElementById("batchAddContainer");
        const commandContainer = document.getElementById("commandContainer");
        const editForm = document.getElementById("editForm");
        const jobNameInputAdd = document.getElementById("addJobName");
        const jobNameInputBatchAdd = document.getElementById("batchAddJobName");
        const jobNameInputEdit = document.getElementById("editJobName");
        const commandJobNameInput = document.getElementById("commandJobName");
        const commandInput = document.getElementById("commandInput");
        const toast = document.getElementById("toast");
        let schedules = JSON.parse(localStorage.getItem("schedules")) || {};
        let jobNames = JSON.parse(localStorage.getItem("jobNames")) || [];
        let jobColors = JSON.parse(localStorage.getItem("jobColors")) || {};
        let currentEditKey = null;

        // æ›´æ–°è‰²ç¥¨ç‚ºæ·¡ç³–æœè‰²ç³»
        const colors = [
          "#ffc0cb",
          "#ffb6c1",
          "#ff69b4",
          "#ff1493",
          "#db7093",
          "#ff8c69",
          "#ff6347",
          "#ff4500",
          "#FFB3BA", // light red
          "#FFDFBA", // light orange
          "#FFFFBA", // light yellow
          "#BAE1FF", // light blue
          "#D9BAFF", // light purple
          "#FFBAF2", // light pink
          "#FFEBBA", // light peacha
          "#FFC6FF", // light lavender
          "#FFBAE5", // light magenta
          "#FFBAB3", // light coral
          "#FFBAC6", // light salmon
          "#FFD1BA", // light apricot
          "#FFFFD1", // light cream
          "#BAD1FF", // light periwinkle
          "#D1BAFF", // light mauve
          "#FFBAD1", // light rose
        ];

        // æ–°å¢å‡½æ•¸ä»¥ç¢ºä¿æ—¥æœŸéµæ­£ç¢º
        function getLocalDateKey(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        // ä½¿ç”¨æ–°çš„ Date ç‰©ä»¶ä¾†è¡¨ç¤ºç•¶å‰é€±çš„èµ·å§‹æ—¥æœŸï¼ˆæ˜ŸæœŸä¸€ï¼‰
        let currentWeekStart = getMonday(new Date());

        function getMonday(d) {
          d = new Date(d);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1); // å¦‚æœæ˜¯æ˜ŸæœŸæ—¥ï¼Œå¾€å‰æ¨6å¤©
          return new Date(d.setDate(diff));
        }

        function updateWeek(direction) {
          // ä¸ä¿®æ”¹åŸå§‹ currentWeekStartï¼Œå‰µå»ºæ–°çš„æ—¥æœŸ
          currentWeekStart = new Date(
            currentWeekStart.getFullYear(),
            currentWeekStart.getMonth(),
            currentWeekStart.getDate() + direction * 7
          );
          generateWeekGrid();
          updateDates();
          updateSchedule();
          updateTotalHours();
          updateTimeScale(); // æ›´æ–°æ™‚é–“åˆ»åº¦
        }

        function generateWeekGrid() {
          const weekGrid = document.querySelector(".week-grid");
          weekGrid.innerHTML = ""; // æ¸…ç©ºåŸæœ‰å…§å®¹
          for (let i = 0; i < 7; i++) {
            const dayColumn = document.createElement("div");
            dayColumn.classList.add("day-column");

            const dayHeader = document.createElement("div");
            dayHeader.classList.add("day-header");
            dayHeader.innerHTML = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][i];
            dayColumn.appendChild(dayHeader);

            const dayContent = document.createElement("div");
            dayContent.classList.add("day-content");
            dayColumn.appendChild(dayContent);

            weekGrid.appendChild(dayColumn);
          }
        }

        function updateDates() {
          const dayHeaders = document.querySelectorAll(".day-header");
          for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            dayHeaders[i].innerHTML =
              ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][i] +
              `<br>${date.getMonth() + 1}/${date.getDate()}`;
          }
        }

        function updateSchedule() {
          const dayContents = document.querySelectorAll(".day-content");
          dayContents.forEach((content) => (content.innerHTML = "")); // æ¸…ç©ºåŸæœ‰å…§å®¹

          const dayContentHeight = dayContents[0].clientHeight;
          const totalMinutesInDay = 17 * 60; // 17 å°æ™‚

          Object.keys(schedules).forEach((dateKey) => {
            const scheduleArray = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            const weekStartDate = new Date(currentWeekStart);
            const weekEndDate = new Date(
              weekStartDate.getFullYear(),
              weekStartDate.getMonth(),
              weekStartDate.getDate() + 7
            );

            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
              scheduleArray.forEach((schedule) => {
                const { id, jobName, start, end } = schedule;
                const color = jobColors[jobName] || "#ff69b4"; // ä½¿ç”¨å·²åˆ†é…çš„é¡è‰²æˆ–é è¨­é¡è‰²
                const dayIndex = (scheduleDate.getDay() + 6) % 7; // å°‡æ˜ŸæœŸæ—¥è½‰ç‚º6
                const startTime = parseTime(start);
                const endTime = parseTime(end);
                const duration = (endTime - startTime) / 60000; // è½‰æ›ç‚ºåˆ†é˜
                const topPosition =
                  (((startTime.getHours() - 7) * 60 + startTime.getMinutes()) /
                    totalMinutesInDay) *
                  dayContentHeight;
                const height =
                  (duration / totalMinutesInDay) * dayContentHeight;
                if (topPosition < 0 || height <= 0) return; // é¿å…é¡¯ç¤ºåœ¨éå·¥ä½œæ™‚é–“

                const scheduleItem = document.createElement("div");
                scheduleItem.classList.add("schedule-item");
                scheduleItem.style.top = `${topPosition}px`;
                scheduleItem.style.height = `${height}px`;
                scheduleItem.style.backgroundColor = color;
                scheduleItem.innerHTML = `ğŸ°<br>${jobName}<br>${formatTime(
                  start
                )}<br><span class="vertical-line"></span><br>${formatTime(
                  end
                )}`;

                // æ–°å¢åˆªé™¤æŒ‰éˆ•
                const deleteButton = document.createElement("button");
                deleteButton.classList.add("delete-btn");
                deleteButton.innerHTML = "X";
                deleteButton.addEventListener("click", (event) => {
                  event.stopPropagation(); // é˜²æ­¢è§¸ç™¼ scheduleItem çš„ click äº‹ä»¶
                  deleteSchedule(dateKey, id, jobName, start, end);
                });
                scheduleItem.appendChild(deleteButton);

                scheduleItem.addEventListener("click", () =>
                  openEditModal(dateKey, id)
                );

                const content = dayContents[dayIndex];
                content.appendChild(scheduleItem);
              });
            }
          });
        }

        function updateTotalHours() {
          let totalHours = 0;
          const weekStartDate = new Date(currentWeekStart);
          const weekEndDate = new Date(
            weekStartDate.getFullYear(),
            weekStartDate.getMonth(),
            weekStartDate.getDate() + 7
          );

          Object.keys(schedules).forEach((dateKey) => {
            const scheduleArray = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
              scheduleArray.forEach((schedule) => {
                const { start, end } = schedule;
                const duration = (parseTime(end) - parseTime(start)) / 3600000; // è½‰æ›ç‚ºå°æ™‚
                totalHours += duration;
              });
            }
          });
          totalHoursElement.textContent = `æœ¬é€±ç¸½å·¥æ™‚ï¼š${totalHours.toFixed(
            1
          )}å°æ™‚`;
        }

        function parseTime(timeStr) {
          // æ”¯æ´ "12:00", "12.", "12.5"
          const [hoursStr, minutesStr] = timeStr.split(":");
          const hours = parseInt(hoursStr, 10);
          let minutes = 0;
          if (minutesStr !== undefined) {
            if (minutesStr.includes(".")) {
              const parts = minutesStr.split(".");
              minutes = parts[1] && parts[1] === "5" ? 30 : 0;
            } else {
              minutes = parseInt(minutesStr, 10);
            }
          }
          return new Date(0, 0, 0, hours, minutes);
        }

        function formatTime(timeStr) {
          const [hours, minutes] = timeStr.split(":").map(Number);
          const period = hours < 12 ? "æ—©ä¸Š" : hours < 18 ? "ä¸‹åˆ" : "æ™šä¸Š";
          const formattedHours = hours % 12 || 12;
          return `${period} ${formattedHours}:${minutes
            .toString()
            .padStart(2, "0")}`;
        }

        function getColorForJob(jobName) {
          if (jobColors[jobName]) {
            return jobColors[jobName];
          } else {
            // é¸æ“‡ä¸€å€‹æœªè¢«ä½¿ç”¨çš„é¡è‰²
            const usedColors = Object.values(jobColors);
            const availableColors = colors.filter(
              (color) => !usedColors.includes(color)
            );
            let color;
            if (availableColors.length > 0) {
              color =
                availableColors[
                  Math.floor(Math.random() * availableColors.length)
                ];
            } else {
              // å¦‚æœè‰²ç¥¨ç”¨å®Œï¼Œéš¨æ©Ÿé¸ä¸€å€‹é¡è‰²
              color = colors[Math.floor(Math.random() * colors.length)];
            }
            jobColors[jobName] = color;
            localStorage.setItem("jobColors", JSON.stringify(jobColors));
            return color;
          }
        }

        function openAddModal() {
          modalAdd.style.display = "block";
          resetAddForms();
        }

        function closeAddModal() {
          modalAdd.style.display = "none";
        }

        function openEditModal(dateKey, scheduleId) {
          const schedule = schedules[dateKey].find((s) => s.id === scheduleId);
          if (!schedule) return;
          currentEditKey = { dateKey, scheduleId };
          document.getElementById("editJobName").value = schedule.jobName;
          document.getElementById("editJobDate").value = dateKey;

          const startHour = String(
            parseInt(parseTime(schedule.start).getHours())
          ).padStart(2, "0");
          const startMinute = String(
            parseInt(parseTime(schedule.start).getMinutes())
          ).padStart(2, "0");
          const endHour = String(
            parseInt(parseTime(schedule.end).getHours())
          ).padStart(2, "0");
          const endMinute = String(
            parseInt(parseTime(schedule.end).getMinutes())
          ).padStart(2, "0");

          document.getElementById("editStartHour").value = startHour;
          document.getElementById("editStartMinute").value = startMinute;
          document.getElementById("editEndHour").value = endHour;
          document.getElementById("editEndMinute").value = endMinute;

          modalEdit.style.display = "block";
        }

        function closeEditModal() {
          modalEdit.style.display = "none";
          currentEditKey = null;
        }

        function deleteSchedule(dateKey, scheduleId, jobName, start, end) {
          if (schedules[dateKey]) {
            schedules[dateKey] = schedules[dateKey].filter(
              (s) => s.id !== scheduleId
            );
            if (schedules[dateKey].length === 0) {
              delete schedules[dateKey];
            }
            localStorage.setItem("schedules", JSON.stringify(schedules));
            updateSchedule();
            updateTotalHours();
            const color = jobColors[jobName] || "#ff1493";
            showToast(
              `å·²åˆªé™¤å·¥ä½œ: ${jobName} (${formatDate(dateKey)} ${formatTime(
                start
              )}-${formatTime(end)})`,
              color
            );
          }
        }

        function saveAddSchedule() {
          const jobName = document.getElementById("addJobName").value.trim();
          const jobDate = document.getElementById("addJobDate").value;
          const startTime =
            document.getElementById("addStartHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("addStartMinute").value.padStart(2, "0");
          const endTime =
            document.getElementById("addEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("addEndMinute").value.padStart(2, "0");
          const color = getColorForJob(jobName);
          const scheduleId = Date.now() + Math.random(); // ä½¿ç”¨æ™‚é–“æˆ³åŠ éš¨æ©Ÿæ•¸ä½œç‚ºå”¯ä¸€ID

          if (new Date(jobDate) < new Date().setHours(0, 0, 0, 0)) {
            alert("é¸æ“‡çš„æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©ã€‚");
            return;
          }

          const newSchedule = {
            id: scheduleId,
            jobName,
            start: startTime,
            end: endTime,
            color,
          };

          const dateKey = getLocalDateKey(new Date(jobDate));
          if (!Array.isArray(schedules[dateKey])) {
            schedules[dateKey] = [];
          }
          schedules[dateKey].push(newSchedule);

          localStorage.setItem("schedules", JSON.stringify(schedules));
          if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem("jobNames", JSON.stringify(jobNames));
          }
          closeAddModal();
          updateSchedule();
          updateTotalHours();
          showToast(
            `å·²æ–°å¢å·¥ä½œ: ${jobName} (${formatDate(jobDate)} ${formatTime(
              startTime
            )}-${formatTime(endTime)})`,
            color
          );
        }

        function saveBatchAddSchedule() {
          const jobName = document
            .getElementById("batchAddJobName")
            .value.trim();
          const startDateInput =
            document.getElementById("batchAddStartDate").value;
          const endDateInput = document.getElementById("batchAddEndDate").value;
          const startDate = new Date(startDateInput);
          const endDate = new Date(endDateInput);
          const startTime =
            document
              .getElementById("batchAddStartHour")
              .value.padStart(2, "0") +
            ":" +
            document
              .getElementById("batchAddStartMinute")
              .value.padStart(2, "0");
          const endTime =
            document.getElementById("batchAddEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("batchAddEndMinute").value.padStart(2, "0");
          const selectedDays = Array.from(
            document.querySelectorAll(".weekday.selected")
          ).map((el) => parseInt(el.dataset.day));
          const color = getColorForJob(jobName);

          if (endDate < startDate) {
            alert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸã€‚");
            return;
          }

          for (
            let date = new Date(startDate);
            date <= endDate;
            date.setDate(date.getDate() + 1)
          ) {
            if (selectedDays.includes(date.getDay())) {
              const dateKey = getLocalDateKey(new Date(date));
              const scheduleId = Date.now() + Math.random(); // ç¢ºä¿å”¯ä¸€æ€§

              const newSchedule = {
                id: scheduleId,
                jobName,
                start: startTime,
                end: endTime,
                color: color,
              };

              if (!Array.isArray(schedules[dateKey])) {
                schedules[dateKey] = [];
              }
              schedules[dateKey].push(newSchedule);
            }
          }

          localStorage.setItem("schedules", JSON.stringify(schedules));
          if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem("jobNames", JSON.stringify(jobNames));
          }
          closeAddModal();
          updateSchedule();
          updateTotalHours();
          showToast(`å·²æ‰¹é‡æ–°å¢å·¥ä½œ: ${jobName}`, color);
        }

        function saveCommandSchedule() {
          const commandJobName = document
            .getElementById("commandJobName")
            .value.trim();
          const commandInputValue =
            document.getElementById("commandInput").value;
          const commands = commandInputValue
            .split("\n")
            .map((cmd) => cmd.trim())
            .filter((cmd) => cmd !== "");

          const jobName = commandJobName || "æŒ‡ä»¤æ–°å¢";
          const color = getColorForJob(jobName);

          commands.forEach((command) => {
            const parsedCommand = parseCommand(command);
            if (parsedCommand) {
              const { startDate, endDate, startTime, endTime, weekdays } =
                parsedCommand;

              for (
                let date = new Date(startDate);
                date <= endDate;
                date.setDate(date.getDate() + 1)
              ) {
                if (weekdays.length === 0 || weekdays.includes(date.getDay())) {
                  const dateKey = getLocalDateKey(new Date(date));
                  const scheduleId = Date.now() + Math.random(); // ç¢ºä¿å”¯ä¸€æ€§

                  const newSchedule = {
                    id: scheduleId,
                    jobName,
                    start: startTime,
                    end: endTime,
                    color: color,
                  };

                  if (!Array.isArray(schedules[dateKey])) {
                    schedules[dateKey] = [];
                  }
                  schedules[dateKey].push(newSchedule);
                }
              }
            }
          });

          localStorage.setItem("schedules", JSON.stringify(schedules));
          if (commandJobName && !jobNames.includes(commandJobName)) {
            jobNames.push(commandJobName);
            localStorage.setItem("jobNames", JSON.stringify(jobNames));
          }
          closeAddModal();
          updateSchedule();
          updateTotalHours();
          showToast(`å·²æ–°å¢å·¥ä½œ: ${jobName}`, color);
        }

        function parseCommand(command) {
          // æ”¯æ´å–®æ—¥å’Œå€é–“æ—¥
          const commandRegex =
            /^(\d{1,2})\/(\d{1,2})(?:\s*[-~]\s*(\d{1,2})\/(\d{1,2}))?\s+([\d.:]{1,5})\s*[-~]\s*([\d.:]{1,5})(?:\s*\(([^)]+)\))?$/;
          const match = command.match(commandRegex);

          if (!match) return null;

          const startMonth = parseInt(match[1], 10);
          const startDay = parseInt(match[2], 10);
          const endMonth = match[3] ? parseInt(match[3], 10) : startMonth;
          const endDay = match[4] ? parseInt(match[4], 10) : startDay;
          const startTimeStr = match[5];
          const endTimeStr = match[6];
          const weekdaysStr = match[7] || "";

          const weekdays = weekdaysStr
            ? weekdaysStr
                .split(",")
                .map((day) => "æ—¥ä¸€äºŒä¸‰å››äº”å…­".indexOf(day.trim()))
                .filter((day) => day !== -1)
            : [];

          const currentYear = new Date().getFullYear();

          const startDate = new Date(currentYear, startMonth - 1, startDay);
          const endDate = new Date(currentYear, endMonth - 1, endDay);

          const startTime = convertTime(startTimeStr);
          const endTime = convertTime(endTimeStr);

          return {
            startDate,
            endDate,
            startTime,
            endTime,
            weekdays,
          };
        }

        function convertTime(timeStr) {
          // æ”¯æ´ "12:00", "12.", "12.5"
          if (timeStr.includes(":")) {
            return timeStr;
          } else if (timeStr.includes(".")) {
            const parts = timeStr.split(".");
            const hours = parts[0].padStart(2, "0");
            let minutes = "00";
            if (parts[1] === "5") {
              minutes = "30";
            }
            return `${hours}:${minutes}`;
          } else {
            return `${timeStr.padStart(2, "0")}:00`;
          }
        }

        function toggleWeekdaySelection(event) {
          event.target.classList.toggle("selected");
        }

        function autocomplete(inp, arr) {
          let currentFocus;
          inp.addEventListener("input", function (e) {
            let a,
              b,
              i,
              val = this.value;
            closeAllLists();
            if (!val) {
              return false;
            }
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            for (i = 0; i < arr.length; i++) {
              if (
                arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()
              ) {
                b = document.createElement("DIV");
                b.innerHTML =
                  "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                b.innerHTML += arr[i].substr(val.length);
                b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                b.addEventListener("click", function (e) {
                  inp.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
                });
                a.appendChild(b);
              }
            }
          });
          inp.addEventListener("keydown", function (e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
              // Down key
              currentFocus++;
              addActive(x);
            } else if (e.keyCode == 38) {
              // Up key
              currentFocus--;
              addActive(x);
            } else if (e.keyCode == 13) {
              // Enter key
              e.preventDefault();
              if (currentFocus > -1) {
                if (x) x[currentFocus].click();
              }
            }
          });
          function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = x.length - 1;
            x[currentFocus].classList.add("autocomplete-active");
          }
          function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
              x[i].classList.remove("autocomplete-active");
            }
          }
          function closeAllLists(elmnt) {
            let x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
              if (elmnt != x[i] && elmnt != inp) {
                x[i].parentNode.removeChild(x[i]);
              }
            }
          }
          document.addEventListener("click", function (e) {
            closeAllLists(e.target);
          });
        }

        function toggleAddMode(selectedMode) {
          // ç§»é™¤æ‰€æœ‰activeç‹€æ…‹
          singleAddToggle.classList.remove("active");
          batchAddToggle.classList.remove("active");
          commandToggle.classList.remove("active");

          // éš±è—æ‰€æœ‰å®¹å™¨
          singleAddContainer.style.display = "none";
          batchAddContainer.style.display = "none";
          commandContainer.style.display = "none";

          // æ ¹æ“šé¸æ“‡çš„æ¨¡å¼é¡¯ç¤ºå°æ‡‰çš„æŒ‰éˆ•å’Œå®¹å™¨
          if (selectedMode === "single") {
            singleAddToggle.classList.add("active");
            singleAddContainer.style.display = "block";
          } else if (selectedMode === "multi") {
            batchAddToggle.classList.add("active");
            batchAddContainer.style.display = "block";
          } else if (selectedMode === "command") {
            commandToggle.classList.add("active");
            commandContainer.style.display = "block";
          }
        }

        addButton.addEventListener("click", () => {
          openAddModal();
        });

        closeAddBtn.addEventListener("click", closeAddModal);
        closeEditBtn.addEventListener("click", closeEditModal);

        window.addEventListener("click", (event) => {
          if (event.target == modalAdd) {
            closeAddModal();
          }
          if (event.target == modalEdit) {
            closeEditModal();
          }
        });

        singleAddToggle.addEventListener("click", () => {
          toggleAddMode("single");
        });

        batchAddToggle.addEventListener("click", () => {
          toggleAddMode("multi");
        });

        commandToggle.addEventListener("click", () => {
          toggleAddMode("command");
        });

        prevWeekBtn.addEventListener("click", () => updateWeek(-1));
        nextWeekBtn.addEventListener("click", () => updateWeek(1));

        addForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveAddSchedule();
        });

        batchAddForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveBatchAddSchedule();
        });

        commandForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveCommandSchedule();
        });

        editForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveEditSchedule();
        });

        function saveEditSchedule() {
          if (!currentEditKey) return;
          const { dateKey, scheduleId } = currentEditKey;

          const jobName = document.getElementById("editJobName").value.trim();
          const jobDate = document.getElementById("editJobDate").value;
          const startTime =
            document.getElementById("editStartHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("editStartMinute").value.padStart(2, "0");
          const endTime =
            document.getElementById("editEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("editEndMinute").value.padStart(2, "0");
          const color = getColorForJob(jobName);

          if (new Date(jobDate) < new Date().setHours(0, 0, 0, 0)) {
            alert("é¸æ“‡çš„æ—¥æœŸä¸èƒ½æ—©æ–¼ä»Šå¤©ã€‚");
            return;
          }

          // æ‰¾åˆ°è¦ç·¨è¼¯çš„å·¥ä½œ
          const scheduleArray = schedules[dateKey];
          const scheduleIndex = scheduleArray.findIndex(
            (s) => s.id === scheduleId
          );
          if (scheduleIndex === -1) return;

          // æ›´æ–°å·¥ä½œå…§å®¹
          scheduleArray[scheduleIndex] = {
            ...scheduleArray[scheduleIndex],
            jobName,
            start: startTime,
            end: endTime,
            color,
          };

          // å¦‚æœæ—¥æœŸè¢«æ›´æ”¹ï¼Œç§»å‹•åˆ°æ–°çš„æ—¥æœŸ
          const newDateKey = getLocalDateKey(new Date(jobDate));
          if (dateKey !== newDateKey) {
            const updatedSchedule = scheduleArray.splice(scheduleIndex, 1)[0];
            if (scheduleArray.length === 0) {
              delete schedules[dateKey];
            }
            if (!Array.isArray(schedules[newDateKey])) {
              schedules[newDateKey] = [];
            }
            schedules[newDateKey].push(updatedSchedule);
          }

          localStorage.setItem("schedules", JSON.stringify(schedules));
          if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem("jobNames", JSON.stringify(jobNames));
          }
          closeEditModal();
          updateSchedule();
          updateTotalHours();
          showToast(
            `å·²ä¿®æ”¹å·¥ä½œ: ${jobName} (${formatDate(jobDate)} ${formatTime(
              startTime
            )}-${formatTime(endTime)})`,
            color
          );
        }

        function updateTimeScale() {
          const timeScale = document.querySelector(".time-scale");
          timeScale.innerHTML = ""; // æ¸…ç©ºåŸæœ‰å…§å®¹

          for (let i = 7; i <= 23; i++) {
            const timeSlot = document.createElement("div");
            timeSlot.classList.add("time-slot");
            timeSlot.innerHTML = `${
              i < 12 ? "æ—©ä¸Š" : i < 18 ? "ä¸‹åˆ" : "æ™šä¸Š"
            } ${i % 12 || 12}:00`;
            timeScale.appendChild(timeSlot);
          }
        }

        function populateTimeOptions() {
          const hours = [...Array(24).keys()].map((i) =>
            String(i).padStart(2, "0")
          );
          const minutes = ["00", "30"]; // ä½¿ç”¨30åˆ†é˜é–“éš”ä»¥ç¬¦åˆè§£æ

          function addOptions(select, options) {
            options.forEach((option) => {
              const opt = document.createElement("option");
              opt.value = option;
              opt.textContent = option;
              select.appendChild(opt);
            });
          }

          [
            "addStartHour",
            "addEndHour",
            "editStartHour",
            "editEndHour",
            "batchAddStartHour",
            "batchAddEndHour",
          ].forEach((id) => {
            addOptions(document.getElementById(id), hours);
          });

          [
            "addStartMinute",
            "addEndMinute",
            "editStartMinute",
            "editEndMinute",
            "batchAddStartMinute",
            "batchAddEndMinute",
          ].forEach((id) => {
            addOptions(document.getElementById(id), minutes);
          });
        }

        function resetAddForms() {
          addForm.reset();
          batchAddForm.reset();
          commandForm.reset();
          document.querySelectorAll(".weekday").forEach((day) => {
            day.classList.remove("selected");
          });
          // é‡ç½®ç‚ºå–®æ¬¡æ¨¡å¼
          toggleAddMode("single");
        }

        function showToast(message, color) {
          toast.textContent = message;
          toast.style.backgroundColor = color || "#ff1493"; // default color
          toast.className = "toast show";
          setTimeout(() => {
            toast.className = toast.className.replace("show", "");
            toast.style.backgroundColor = ""; // reset color
          }, 3000);
        }

        generateWeekGrid();
        updateDates();
        updateSchedule();
        updateTotalHours();
        updateTimeScale(); // åˆå§‹åŒ–æ™‚é–“åˆ»åº¦
        autocomplete(jobNameInputAdd, jobNames);
        autocomplete(jobNameInputBatchAdd, jobNames);
        autocomplete(jobNameInputEdit, jobNames);
        autocomplete(commandJobNameInput, jobNames);
        populateTimeOptions();

        document.querySelectorAll(".weekday").forEach((day) => {
          day.addEventListener("click", toggleWeekdaySelection);
        });

        // ç¦æ­¢é›™æ“Šç¸®æ”¾
        let lastTouchEnd = 0;
        document.addEventListener(
          "touchend",
          function (event) {
            let now = new Date().getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          },
          false
        );
      });

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }
    </script>
  </body>
</html>
