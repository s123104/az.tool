<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>可愛兔兔排班表</title>
    <link
      rel="icon"
      href="https://s123104.github.io/az.tool/img/magician-hat.png"
    />
    <style>
      /* 基本樣式 */
      body,
      html {
        font-family: "Arial", sans-serif;
        background-color: #fff0f5;
        color: #ff69b4;
        margin: 0;
        padding: 0;
        font-size: 12px;
        height: 100%;
      }

      .calendar-container {
        display: flex;
        flex-direction: column;
        height: 100%; /* 使用視窗高度 */
        background-color: #ffebee;
      }

      .header {
        text-align: center;
        padding: 10px;
        background-color: #ff69b4;
        color: white;
        position: relative;
        flex: 0 0 auto;
      }

      .title {
        font-size: 18px;
        font-weight: bold;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .title img {
        margin-right: 8px;
        height: 24px;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
      }

      .nav-button {
        background-color: #ff1493;
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .add-button {
        position: absolute;
        top: 5px;
        right: 10px;
        background-color: #ff1493;
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        font-size: 16px;
        line-height: 16px;
        cursor: pointer;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
      }

      .add-button:hover {
        background-color: #ff69b4;
      }

      .week-view {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
        flex: 1 1 auto;
      }

      .time-scale {
        position: relative;
        width: 45px;
        background-color: #ffd1dc;
        font-size: 8px;
        text-align: right;
        padding-top: 50px;
        padding-left: 2px;
      }

      .time-slot {
        position: relative;
        height: calc(100% / 17); /* 每個時間段佔1/17的高度 */
      }

      .week-grid {
        display: flex;
        flex-grow: 1;
        overflow-y: auto; /* 允許垂直滾動 */
      }

      .day-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #ff69b4;
        position: relative;
      }

      .day-column:last-child {
        border-right: none;
      }

      .day-header {
        text-align: center;
        padding: 5px 0;
        font-weight: bold;
        background-color: #ffd1dc;
        border-bottom: 1px solid #ff69b4;
        cursor: pointer; /* 改變游標 */
        transition: background-color 0.3s;
      }

      .day-header:hover {
        background-color: #ffb6c1; /* 滑鼠移動時背景顏色變化 */
      }

      .day-content {
        flex-grow: 1;
        position: relative;
        overflow: hidden;
      }

      .schedule-item {
        position: absolute;
        left: 2px;
        right: 2px;
        color: white;
        font-size: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-around;
        border-radius: 8px; /* 圓角 */
        padding: 2px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .schedule-item:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .vertical-line {
        display: inline-block;
        width: 1px;
        height: 8px;
        background-color: white;
        margin: 2px 0;
      }

      .total-hours {
        text-align: center;
        padding: 10px;
        font-weight: bold;
        background-color: #ff69b4;
        color: white;
        flex: 0 0 auto;
      }

      /* 現有模態框的樣式 */
      .modal {
        display: none; /* 隱藏模態框 */
        position: fixed; /* 固定位置 */
        z-index: 1000; /* 確保在最上層 */
        left: 0;
        top: 0;
        width: 100%; /* 全寬 */
        height: 100%; /* 全高 */
        overflow: auto; /* 滾動 */
        background-color: rgba(0, 0, 0, 0.5); /* 半透明背景 */
      }

      .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 垂直和水平置中 */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* 寬度 */
        max-width: 600px; /* 最大寬度 */
        border-radius: 8px; /* 圓角 */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
      }

      /* 新增的當日工作列表樣式 */
      .day-schedule-list {
        list-style-type: none;
        padding: 0;
        max-height: 400px;
        overflow-y: auto;
      }

      .day-schedule-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        border-radius: 8px; /* 圓角 */
        background-color: white; /* 底色設為白色 */
        margin-bottom: 5px;
        transition: background-color 0.3s;
      }

      .job-info {
        flex: 1;
        margin-right: 10px;
      }

      .job-actions {
        display: flex;
        gap: 0; /* 移除按鈕之間的空隙 */
      }

      /* 統一「修改」和「刪除」按鈕的樣式 */
      .job-actions .action-btn,
      .delete-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 20px; /* 圓弧 */
        cursor: pointer;
        font-size: 10px;
        transition: background-color 0.3s;
      }

      .job-actions .edit-btn {
        background-color: #ff69b4; /* 一致的粉色系列 */
        color: white;
        margin-right: 5px; /* 移除右側間距 */
      }

      .job-actions .edit-btn:hover {
        background-color: #ff1493;
      }

      .job-actions .delete-btn {
        background-color: #ff5781; /* 一致的粉色系列 */
        color: white;
        margin-right: 0; /* 移除右側間距 */
      }

      .job-actions .delete-btn:hover {
        background-color: #ff1447;
      }

      /* 保留外側模態框的刪除按鈕樣式 */
      .schedule-item .delete-btn {
        background-color: #ff4c4c;
        border: none;
        color: white;
        font-size: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        cursor: pointer;
        position: absolute;
        top: 2px;
        right: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: background-color 0.3s;
      }

      .schedule-item .delete-btn:hover {
        background-color: #ff0000;
      }

      .toggle-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }

      .toggle-button {
        padding: 5px 15px;
        cursor: pointer;
        text-align: center;
        border-radius: 15px;
        color: white;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .toggle-button.single {
        background-color: #ffb6c1;
      }

      .toggle-button.multi {
        background-color: #ffb6c1;
      }

      .toggle-button.command {
        background-color: #ffb6c1;
      }

      .toggle-button.active {
        background-color: #ff1493;
      }

      label {
        display: block;
        margin: 10px 0 5px;
      }

      input[type="text"],
      input[type="date"],
      textarea {
        width: calc(100% - 10px);
        padding: 5px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .time-input-wrapper {
        display: flex;
        align-items: center;
      }

      .time-input-wrapper select {
        width: 45%;
        margin: 5px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }

      .weekdays {
        display: flex;
        justify-content: space-between;
        margin: 10px 0;
      }

      .weekday {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: #ffb6c1;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s, transform 0.3s;
      }

      .weekday:hover {
        background-color: #ff69b4;
        transform: scale(1.1);
      }

      .weekday.selected {
        background-color: #ff1493;
      }

      button[type="submit"] {
        background-color: #ff1493;
        border: none;
        color: white;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        transition: background-color 0.3s;
      }

      button[type="submit"]:hover {
        background-color: #ff69b4;
      }

      .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: #fff;
        max-height: 150px;
        overflow-y: auto;
      }

      .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #d4d4d4;
      }

      .autocomplete-items div:hover {
        background-color: #e9e9e9;
      }

      .autocomplete-active {
        background-color: DodgerBlue !important;
        color: #ffffff;
      }

      /* 浮動提示窗樣式 */
      .toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #ff1493;
        color: white;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1000;
        right: 30px;
        bottom: 30px; /* 移至底部 */
        font-size: 14px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        transition: opacity 0.5s;
      }

      .toast.show {
        visibility: visible;
        opacity: 1;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      /* 手機介面調整 */
      @media only screen and (max-width: 600px) {
        .calendar-container {
          padding: 0;
          width: 100%;
        }

        .header {
          padding: 5px;
        }

        .title {
          font-size: 16px;
        }

        .nav-button,
        .add-button {
          padding: 3px 7px;
          font-size: 10px;
        }

        .add-button {
          width: 25px;
          height: 25px;
          line-height: 25px;
          font-size: 14px;
          top: 5px;
        }

        .time-scale {
          font-size: 7px;
          width: 40px;
        }

        .total-hours {
          padding: 5px;
          font-size: 10px;
        }

        .modal-content {
          width: 95%;
          max-width: 300px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        button[type="submit"] {
          padding: 7px;
          margin: 3px 0;
        }

        button[type="submit"] {
          font-size: 14px;
        }

        .schedule-item {
          font-size: 7px;
        }
      }
    </style>
  </head>
  <body>
    <div class="calendar-container">
      <div class="header">
        <h1 class="title">
          <img
            src="https://s123104.github.io/az.tool/img/magician-hat.png"
            alt="magician hat"
          />
          可愛兔兔排班表
        </h1>
        <button class="add-button" id="addButton">+</button>
        <div class="navigation">
          <button class="nav-button" id="prevWeek">上一週</button>
          <button class="nav-button" id="nextWeek">下一週</button>
        </div>
      </div>
      <div class="week-view">
        <div class="time-scale" id="timeScale"></div>
        <div class="week-grid">
          <!-- 這些內容由JavaScript動態生成 -->
        </div>
      </div>
      <div class="total-hours" id="totalHours">本週總工時：0小時</div>
    </div>

    <!-- 新增工作模態框 -->
    <div id="modal-add" class="modal">
      <div class="modal-content">
        <span class="close" id="closeAdd">&times;</span>
        <div class="toggle-container">
          <div class="toggle-button single active" id="singleAddToggle">
            單次
          </div>
          <div class="toggle-button multi" id="batchAddToggle">批量</div>
          <div class="toggle-button command" id="commandToggle">指令</div>
        </div>
        <div id="singleAddContainer">
          <h2>新增工作</h2>
          <form id="addForm" autocomplete="off">
            <label for="addJobName">工作名稱</label>
            <input
              type="text"
              id="addJobName"
              name="addJobName"
              maxlength="4"
              required
            />
            <label for="addJobDate">日期</label>
            <input type="date" id="addJobDate" name="addJobDate" required />
            <label for="addStartTime">開始時間</label>
            <div class="time-input-wrapper">
              <select id="addStartHour" name="addStartHour" required></select>
              :
              <select
                id="addStartMinute"
                name="addStartMinute"
                required
              ></select>
            </div>
            <label for="addEndTime">結束時間</label>
            <div class="time-input-wrapper">
              <select id="addEndHour" name="addEndHour" required></select>
              :
              <select id="addEndMinute" name="addEndMinute" required></select>
            </div>
            <button type="submit">保存</button>
          </form>
        </div>
        <div id="batchAddContainer" style="display: none">
          <h2>批量新增工作</h2>
          <form id="batchAddForm" autocomplete="off">
            <label for="batchAddJobName">工作名稱</label>
            <input
              type="text"
              id="batchAddJobName"
              name="batchAddJobName"
              maxlength="4"
              required
            />
            <label for="batchAddStartDate">開始日期</label>
            <input
              type="date"
              id="batchAddStartDate"
              name="batchAddStartDate"
              required
            />
            <label for="batchAddEndDate">結束日期</label>
            <input
              type="date"
              id="batchAddEndDate"
              name="batchAddEndDate"
              required
            />
            <label for="batchAddStartTime">開始時間</label>
            <div class="time-input-wrapper">
              <select
                id="batchAddStartHour"
                name="batchAddStartHour"
                required
              ></select>
              :
              <select
                id="batchAddStartMinute"
                name="batchAddStartMinute"
                required
              ></select>
            </div>
            <label for="batchAddEndTime">結束時間</label>
            <div class="time-input-wrapper">
              <select
                id="batchAddEndHour"
                name="batchAddEndHour"
                required
              ></select>
              :
              <select
                id="batchAddEndMinute"
                name="batchAddEndMinute"
                required
              ></select>
            </div>
            <div class="weekdays">
              <div class="weekday" data-day="1">一</div>
              <div class="weekday" data-day="2">二</div>
              <div class="weekday" data-day="3">三</div>
              <div class="weekday" data-day="4">四</div>
              <div class="weekday" data-day="5">五</div>
              <div class="weekday" data-day="6">六</div>
              <div class="weekday" data-day="0">日</div>
            </div>
            <button type="submit">批量保存</button>
          </form>
        </div>
        <div id="commandContainer" style="display: none">
          <h2>指令快速新增</h2>
          <form id="commandForm" autocomplete="off">
            <label for="commandJobName">工作名稱</label>
            <input
              type="text"
              id="commandJobName"
              name="commandJobName"
              maxlength="4"
              required
            />
            <label for="commandInput">輸入指令:</label>
            <textarea
              id="commandInput"
              name="commandInput"
              rows="5"
              required
            ></textarea>
            <details>
              <summary>點此查看指令範例</summary>
              <p>格式說明:</p>
              <ul>
                <li>工作名稱: 透過上方「工作名稱」欄位輸入。</li>
                <li>
                  指令格式:
                  <ul>
                    <li>
                      區間內不指定星期:
                      <ul>
                        <li>範例一:10/10-10/13 12:00-20:30</li>
                        <li>範例二:10/15~10/18 12.-20.5</li>
                      </ul>
                    </li>
                    <li>
                      區間內指定星期:
                      <ul>
                        <li>範例一:10/10-10/13 12:00-20:30(一,三,五)</li>
                        <li>範例二:10/15~10/18 12.-20.5(一,三,五)</li>
                      </ul>
                    </li>
                    <li>
                      單日:
                      <ul>
                        <li>範例一:10/13 12:00-20:30</li>
                        <li>範例二:10/13 12.-20.5</li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li>特殊規則: -~為區間符號, 12.為12:00簡寫, 12.5為12:30簡寫</li>
              </ul>
            </details>
            <button type="submit">執行指令</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 修改工作模態框 -->
    <div id="modal-edit" class="modal">
      <div class="modal-content">
        <span class="close" id="closeEdit">&times;</span>
        <h2>修改工作</h2>
        <form id="editForm" autocomplete="off">
          <label for="editJobName">工作名稱</label>
          <input
            type="text"
            id="editJobName"
            name="editJobName"
            maxlength="4"
            required
          />
          <label for="editJobDate">日期</label>
          <input type="date" id="editJobDate" name="editJobDate" required />
          <label for="editStartTime">開始時間</label>
          <div class="time-input-wrapper">
            <select id="editStartHour" name="editStartHour" required></select>
            :
            <select
              id="editStartMinute"
              name="editStartMinute"
              required
            ></select>
          </div>
          <label for="editEndTime">結束時間</label>
          <div class="time-input-wrapper">
            <select id="editEndHour" name="editEndHour" required></select>
            :
            <select id="editEndMinute" name="editEndMinute" required></select>
          </div>
          <button type="submit">保存</button>
        </form>
      </div>
    </div>

    <!-- 新增的模態框：檢視當日工作 -->
    <div id="modal-view-day" class="modal">
      <div class="modal-content">
        <span class="close" id="closeViewDay">&times;</span>
        <h2 id="viewDayTitle">工作列表</h2>
        <ul id="dayScheduleList" class="day-schedule-list">
          <!-- 動態生成的工作項目將插入於此 -->
        </ul>
      </div>
    </div>

    <!-- 浮動提示窗 -->
    <div id="toast" class="toast"></div>
    <script>
      document.addEventListener("DOMContentLoaded", (event) => {
        const prevWeekBtn = document.getElementById("prevWeek");
        const nextWeekBtn = document.getElementById("nextWeek");
        const totalHoursElement = document.getElementById("totalHours");
        const addButton = document.getElementById("addButton");
        const modalAdd = document.getElementById("modal-add");
        const modalEdit = document.getElementById("modal-edit");
        const modalViewDay = document.getElementById("modal-view-day");
        const closeAddBtn = document.getElementById("closeAdd");
        const closeEditBtn = document.getElementById("closeEdit");
        const closeViewDayBtn = document.getElementById("closeViewDay");
        const addForm = document.getElementById("addForm");
        const batchAddForm = document.getElementById("batchAddForm");
        const commandForm = document.getElementById("commandForm");
        const singleAddToggle = document.getElementById("singleAddToggle");
        const batchAddToggle = document.getElementById("batchAddToggle");
        const commandToggle = document.getElementById("commandToggle");
        const singleAddContainer =
          document.getElementById("singleAddContainer");
        const batchAddContainer = document.getElementById("batchAddContainer");
        const commandContainer = document.getElementById("commandContainer");
        const editForm = document.getElementById("editForm");
        const viewDayTitle = document.getElementById("viewDayTitle");
        const dayScheduleList = document.getElementById("dayScheduleList");
        const jobNameInputAdd = document.getElementById("addJobName");
        const jobNameInputBatchAdd = document.getElementById("batchAddJobName");
        const jobNameInputEdit = document.getElementById("editJobName");
        const commandJobNameInput = document.getElementById("commandJobName");
        const commandInput = document.getElementById("commandInput");
        const toast = document.getElementById("toast");
        let schedules = JSON.parse(localStorage.getItem("schedules")) || {};
        let jobNames = JSON.parse(localStorage.getItem("jobNames")) || [];
        let jobColors = JSON.parse(localStorage.getItem("jobColors")) || {};
        let currentEditKey = null;

        const colors = [
          "#ffc0cb",
          "#ffb6c1",
          "#ff69b4",
          "#ff1493",
          "#db7093",
          "#ff8c69",
          "#ff6347",
          "#ff4500",
          "#FFB3BA",
          "#FFDFBA",
          "#BAE1FF",
          "#D9BAFF",
          "#FFBAF2",
          "#FFC6FF",
          "#FFBAE5",
          "#FFBAB3",
          "#FFBAC6",
          "#FFD1BA",
          "#BAD1FF",
          "#D1BAFF",
          "#FFBAD1",
        ];

        function getLocalDateKey(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        let currentWeekStart = getMonday(new Date());

        function getMonday(d) {
          d = new Date(d);
          const day = d.getDay();
          const diff = d.getDate() - day + (day === 0 ? -6 : 1);
          return new Date(d.setDate(diff));
        }

        function updateWeek(direction) {
          currentWeekStart = new Date(
            currentWeekStart.getFullYear(),
            currentWeekStart.getMonth(),
            currentWeekStart.getDate() + direction * 7
          );
          generateWeekGrid();
          updateDates();
          updateTimeScale();
          requestAnimationFrame(() => {
            updateSchedule();
            updateTotalHours();
          });
        }

        function generateWeekGrid() {
          const weekGrid = document.querySelector(".week-grid");
          weekGrid.innerHTML = "";
          for (let i = 0; i < 7; i++) {
            const dayColumn = document.createElement("div");
            dayColumn.classList.add("day-column");

            const dayHeader = document.createElement("div");
            dayHeader.classList.add("day-header");
            dayHeader.innerHTML = ["一", "二", "三", "四", "五", "六", "日"][i];
            dayHeader.dataset.dayIndex = i;
            dayColumn.appendChild(dayHeader);

            const dayContent = document.createElement("div");
            dayContent.classList.add("day-content");
            dayColumn.appendChild(dayContent);

            weekGrid.appendChild(dayColumn);

            dayHeader.addEventListener("click", () => {
              const date = new Date(currentWeekStart);
              date.setDate(date.getDate() + i);
              const dateKey = getLocalDateKey(date);
              openViewDayModal(dateKey);
            });
          }
        }

        function updateDates() {
          const dayHeaders = document.querySelectorAll(".day-header");
          for (let i = 0; i < 7; i++) {
            const date = new Date(currentWeekStart);
            date.setDate(date.getDate() + i);
            dayHeaders[i].innerHTML =
              ["一", "二", "三", "四", "五", "六", "日"][i] +
              `<br>${date.getMonth() + 1}/${date.getDate()}`;
          }
        }

        function updateSchedule() {
          const dayContents = document.querySelectorAll(".day-content");
          dayContents.forEach((content) => (content.innerHTML = ""));

          const dayContentHeight = dayContents[0].clientHeight;
          const totalMinutesInDay = 17 * 60;

          Object.keys(schedules).forEach((dateKey) => {
            const scheduleArray = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            const weekStartDate = new Date(currentWeekStart);
            const weekEndDate = new Date(
              weekStartDate.getFullYear(),
              weekStartDate.getMonth(),
              weekStartDate.getDate() + 7
            );

            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
              scheduleArray.forEach((schedule) => {
                const { id, jobName, start, end } = schedule;
                const color = jobColors[jobName] || "#ff69b4";
                const dayIndex = (scheduleDate.getDay() + 6) % 7;
                const startTime = parseTime(start);
                const endTime = parseTime(end);

                if (!startTime || !endTime) {
                  console.error(`無法解析時間: ${start} 或 ${end}`);
                  return;
                }

                const duration = (endTime - startTime) / 60000;
                const topPosition =
                  (((startTime.getHours() - 7) * 60 + startTime.getMinutes()) /
                    totalMinutesInDay) *
                  dayContentHeight;
                const height =
                  (duration / totalMinutesInDay) * dayContentHeight;
                if (topPosition < 0 || height <= 0) return;

                const scheduleItem = document.createElement("div");
                scheduleItem.classList.add("schedule-item");
                scheduleItem.style.top = `${topPosition}px`;
                scheduleItem.style.height = `${height}px`;
                scheduleItem.style.backgroundColor = color;
                scheduleItem.innerHTML = `🐰<br>${jobName}<br>${formatTime(
                  start
                )}<br><span class="vertical-line"></span><br>${formatTime(
                  end
                )}`;

                const deleteButton = document.createElement("button");
                deleteButton.classList.add("delete-btn");
                deleteButton.innerHTML = "X";
                deleteButton.addEventListener("click", (event) => {
                  event.stopPropagation();
                  deleteSchedule(dateKey, id, jobName, start, end);
                  scheduleItem.remove();
                  updateTotalHours();
                  showToast(`已刪除工作 (${formatDate(dateKey)})`, "#ff1493");
                });
                scheduleItem.appendChild(deleteButton);

                scheduleItem.addEventListener("click", () =>
                  openEditModal(dateKey, id)
                );

                const content = dayContents[dayIndex];
                content.appendChild(scheduleItem);
              });
            }
          });
        }

        function updateTotalHours() {
          let totalHours = 0;
          const weekStartDate = new Date(currentWeekStart);
          const weekEndDate = new Date(
            weekStartDate.getFullYear(),
            weekStartDate.getMonth(),
            weekStartDate.getDate() + 7
          );

          Object.keys(schedules).forEach((dateKey) => {
            const scheduleArray = schedules[dateKey];
            const scheduleDate = new Date(dateKey);
            if (scheduleDate >= weekStartDate && scheduleDate < weekEndDate) {
              scheduleArray.forEach((schedule) => {
                const { start, end } = schedule;
                const startTime = parseTime(start);
                const endTime = parseTime(end);
                if (!startTime || !endTime) {
                  console.error(`無法解析時間: ${start} 或 ${end}`);
                  return;
                }
                const duration = (endTime - startTime) / 3600000;
                totalHours += duration;
              });
            }
          });
          totalHoursElement.textContent = `本週總工時：${totalHours.toFixed(
            1
          )} 小時`;
        }

        function parseTime(timeStr) {
          if (timeStr.includes(":")) {
            const [hoursStr, minutesStr] = timeStr.split(":");
            const hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr, 10);
            if (isNaN(hours) || isNaN(minutes)) {
              console.error(`無效的時間格式: ${timeStr}`);
              return null;
            }
            return new Date(0, 0, 0, hours, minutes);
          } else if (timeStr.includes(".")) {
            const parts = timeStr.split(".");
            const hours = parseInt(parts[0], 10);
            let minutes = 0;
            if (parts[1]) {
              if (parts[1].length === 1) {
                if (parts[1] === "5") {
                  minutes = 30;
                } else {
                  minutes = parseInt(parts[1], 10) * 10;
                }
              } else if (parts[1].length === 2) {
                minutes = parseInt(parts[1], 10);
              }
            }
            if (isNaN(hours) || isNaN(minutes)) {
              console.error(`無效的時間格式: ${timeStr}`);
              return null;
            }
            return new Date(0, 0, 0, hours, minutes);
          } else {
            const hours = parseInt(timeStr, 10);
            if (isNaN(hours)) {
              console.error(`無效的時間格式: ${timeStr}`);
              return null;
            }
            return new Date(0, 0, 0, hours, 0);
          }
        }

        function formatTime(timeStr) {
          const [hours, minutes] = timeStr.split(":").map(Number);
          if (isNaN(hours) || isNaN(minutes)) {
            console.error(`無法格式化時間: ${timeStr}`);
            return timeStr;
          }
          const period = hours < 12 ? "早上" : hours < 18 ? "下午" : "晚上";
          const formattedHours = hours % 12 || 12;
          return `${period} ${formattedHours}:${minutes
            .toString()
            .padStart(2, "0")}`;
        }

        function getColorForJob(jobName) {
          if (jobColors[jobName]) {
            return jobColors[jobName];
          } else {
            const usedColors = Object.values(jobColors);
            const availableColors = colors.filter(
              (color) => !usedColors.includes(color)
            );
            let color;
            if (availableColors.length > 0) {
              color =
                availableColors[
                  Math.floor(Math.random() * availableColors.length)
                ];
            } else {
              color = colors[Math.floor(Math.random() * colors.length)];
            }
            jobColors[jobName] = color;
            localStorage.setItem("jobColors", JSON.stringify(jobColors));
            return color;
          }
        }

        function openAddModal() {
          modalAdd.style.display = "block";
          resetAddForms();
        }

        function closeAddModal() {
          modalAdd.style.display = "none";
        }

        function openEditModal(dateKey, scheduleId) {
          const schedule = schedules[dateKey].find((s) => s.id === scheduleId);
          if (!schedule) return;
          currentEditKey = { dateKey, scheduleId };
          document.getElementById("editJobName").value = schedule.jobName;
          document.getElementById("editJobDate").value = dateKey;

          const startTimeObj = parseTime(schedule.start);
          const endTimeObj = parseTime(schedule.end);

          if (!startTimeObj || !endTimeObj) {
            console.error(`無法解析時間: ${schedule.start} 或 ${schedule.end}`);
            return;
          }

          const startHour = String(startTimeObj.getHours()).padStart(2, "0");
          const startMinute = String(startTimeObj.getMinutes()).padStart(
            2,
            "0"
          );
          const endHour = String(endTimeObj.getHours()).padStart(2, "0");
          const endMinute = String(endTimeObj.getMinutes()).padStart(2, "0");

          document.getElementById("editStartHour").value = startHour;
          document.getElementById("editStartMinute").value = startMinute;
          document.getElementById("editEndHour").value = endHour;
          document.getElementById("editEndMinute").value = endMinute;

          modalEdit.style.display = "block";
        }

        function closeEditModal() {
          modalEdit.style.display = "none";
          currentEditKey = null;
        }

        function openViewDayModal(dateKey) {
          const date = new Date(dateKey);
          const formattedDate = `${date.getMonth() + 1}/${date.getDate()}`;
          viewDayTitle.textContent = `工作列表 - ${formattedDate}`;
          populateDayScheduleList(dateKey);
          modalViewDay.style.display = "block";
        }

        function closeViewDayModal() {
          modalViewDay.style.display = "none";
          dayScheduleList.innerHTML = "";
        }

        function populateDayScheduleList(dateKey) {
          dayScheduleList.innerHTML = "";
          const scheduleArray = schedules[dateKey] || [];

          scheduleArray.sort((a, b) => {
            const startA = parseTime(a.start).getTime();
            const startB = parseTime(b.start).getTime();
            return startA - startB;
          });

          if (scheduleArray.length === 0) {
            const noScheduleItem = document.createElement("li");
            noScheduleItem.textContent = "當日無任何工作。";
            dayScheduleList.appendChild(noScheduleItem);
            return;
          }

          scheduleArray.forEach((schedule) => {
            const { id, jobName, start, end, color } = schedule;

            const listItem = document.createElement("li");
            listItem.classList.add("day-schedule-item");
            listItem.style.borderLeft = `4px solid ${color}`;

            const jobInfo = document.createElement("div");
            jobInfo.classList.add("job-info");
            jobInfo.innerHTML = `<strong>${jobName}</strong><br>${formatTime(
              start
            )} - ${formatTime(end)}`;
            listItem.appendChild(jobInfo);

            const actions = document.createElement("div");
            actions.classList.add("job-actions");

            const editBtn = document.createElement("button");
            editBtn.classList.add("action-btn", "edit-btn");
            editBtn.textContent = "修改";
            editBtn.addEventListener("click", () => {
              closeViewDayModal();
              openEditModal(dateKey, id);
            });
            actions.appendChild(editBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.classList.add("action-btn", "delete-btn");
            deleteBtn.textContent = "刪除";
            deleteBtn.addEventListener("click", () => {
              deleteSchedule(dateKey, id, jobName, start, end);
              populateDayScheduleList(dateKey);
            });
            actions.appendChild(deleteBtn);

            listItem.appendChild(actions);
            dayScheduleList.appendChild(listItem);
          });
        }

        function deleteSchedule(dateKey, scheduleId, jobName, start, end) {
          if (schedules[dateKey]) {
            schedules[dateKey] = schedules[dateKey].filter(
              (s) => s.id !== scheduleId
            );
            if (schedules[dateKey].length === 0) {
              delete schedules[dateKey];
            }
            localStorage.setItem("schedules", JSON.stringify(schedules));
            updateSchedule();
            updateTotalHours();
            const color = jobColors[jobName] || "#ff1493";
            showToast(
              `已刪除工作: ${jobName} (${formatDate(dateKey)} ${formatTime(
                start
              )}-${formatTime(end)})`,
              color
            );
          }
        }

        function findOverlaps(dateKey, newSchedule, ignoreScheduleId) {
          const overlaps = [];
          const scheduleArray = schedules[dateKey] || [];
          const newStart = parseTime(newSchedule.start).getTime();
          const newEnd = parseTime(newSchedule.end).getTime();
          for (const existingSchedule of scheduleArray) {
            if (ignoreScheduleId && existingSchedule.id === ignoreScheduleId) {
              continue;
            }
            const existingStart = parseTime(existingSchedule.start).getTime();
            const existingEnd = parseTime(existingSchedule.end).getTime();
            if (newStart < existingEnd && newEnd > existingStart) {
              overlaps.push(existingSchedule);
            }
          }
          return overlaps;
        }

        const overlapModal = document.createElement("div");
        overlapModal.id = "overlapModal";
        overlapModal.className = "modal";
        overlapModal.innerHTML = `
          <div class="modal-content">
            <span class="close" id="closeOverlapModal">&times;</span>
            <h2>時間重疊</h2>
            <div id="overlapContent"></div>
            <div class="overlap-actions">
              <button id="replaceButton" class="rounded-button">取代</button>
              <button id="replaceAllButton" class="rounded-button">全部取代</button>
              <button id="cancelOverlapButton" class="rounded-button">取消</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlapModal);

        const style = document.createElement("style");
        style.innerHTML = `
          .rounded-button {
            background-color: #ff69b4;
            border: none;
            color: white;
            padding: 10px 20px;
            margin: 5px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
          }
          .overlap-actions {
            text-align: center;
          }
          .overlap-schedule {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
          }
          .overlap-schedule .schedule-details {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
          }
          .schedule-details .color-block {
            width: 10px;
            height: 100%;
            background-color: #ff69b4;
            margin-right: 10px;
          }
          .schedule-details .schedule-info {
            flex: 1;
          }
          .arrow-with-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
          }
          .arrow {
            font-size: 24px;
            color: #ff69b4;
          }
          .replace-text {
            font-size: 14px;
            color: #555;
          }
          @media (max-width: 600px) {
            .overlap-schedule {
              flex-direction: column;
            }
            .rounded-button {
              font-size: 14px;
              padding: 8px 16px;
            }
          }
        `;
        document.head.appendChild(style);

        const closeOverlapModalBtn =
          document.getElementById("closeOverlapModal");
        const replaceButton = document.getElementById("replaceButton");
        const replaceAllButton = document.getElementById("replaceAllButton");
        const cancelOverlapButton = document.getElementById(
          "cancelOverlapButton"
        );
        const overlapContent = document.getElementById("overlapContent");

        let pendingOverlaps = [];
        let pendingIndex = 0;
        let pendingAction = null;
        let pendingDatesToAdd = [];
        let isBatch = false;

        function showOverlapModal(overlaps, action) {
          pendingOverlaps = overlaps;
          pendingIndex = 0;
          pendingAction = action;
          updateOverlapModal();
          overlapModal.style.display = "block";
        }

        function updateOverlapModal() {
          const currentOverlap = pendingOverlaps[pendingIndex];
          const { dateKey, overlap, newSchedule } = currentOverlap;
          overlapContent.innerHTML = `
            <p>日期：${formatDate(dateKey)}</p>
            <div class="overlap-schedule">
              <div class="schedule-details">
                <div class="color-block" style="background-color: ${
                  jobColors[overlap.jobName] || "#ff69b4"
                };"></div>
                <div class="schedule-info">
                  <p><strong>${overlap.jobName}</strong></p>
                  <p>${formatTime(overlap.start)} - ${formatTime(
            overlap.end
          )}</p>
                </div>
              </div>
              <div class="arrow-with-text">
                <div class="arrow">↓</div>
              </div>
              <div class="schedule-details">
                <div class="color-block" style="background-color: ${
                  jobColors[newSchedule.jobName] || "#ff69b4"
                };"></div>
                <div class="schedule-info">
                  <p><strong>${newSchedule.jobName}</strong></p>
                  <p>${formatTime(newSchedule.start)} - ${formatTime(
            newSchedule.end
          )}</p>
                </div>
              </div>
            </div>
            <p>請選擇操作：</p>
          `;
          const remaining = pendingOverlaps.length - pendingIndex - 1;
          replaceAllButton.textContent = `全部取代(${remaining})`;
        }

        function closeOverlapModal() {
          overlapModal.style.display = "none";
          pendingOverlaps = [];
          pendingIndex = 0;
          pendingAction = null;
          pendingDatesToAdd = [];
          isBatch = false;
        }

        closeOverlapModalBtn.addEventListener("click", closeOverlapModal);
        cancelOverlapButton.addEventListener("click", closeOverlapModal);

        replaceButton.addEventListener("click", () => {
          if (pendingAction) {
            pendingAction("replace");
          }
        });

        replaceAllButton.addEventListener("click", () => {
          if (pendingAction) {
            pendingAction("replaceAll");
          }
        });

        window.addEventListener("click", (event) => {
          if (event.target == overlapModal) {
            closeOverlapModal();
          }
        });

        function removeOverlap(dateKey, overlapSchedule) {
          schedules[dateKey] = schedules[dateKey].filter(
            (s) => s.id !== overlapSchedule.id
          );
          if (schedules[dateKey].length === 0) {
            delete schedules[dateKey];
          }
        }

        function handleOverlapAction(action) {
          if (action === "replace") {
            const { dateKey, overlap, newSchedule } =
              pendingOverlaps[pendingIndex];
            removeOverlap(dateKey, overlap);
            addScheduleToStorage(dateKey, newSchedule, newSchedule.jobName);
            pendingIndex++;
            if (pendingIndex < pendingOverlaps.length) {
              updateOverlapModal();
            } else {
              if (isBatch) {
                pendingDatesToAdd.forEach(({ dateKey, newSchedule }) => {
                  addScheduleToStorage(
                    dateKey,
                    newSchedule,
                    newSchedule.jobName
                  );
                });
                showToast(
                  `已批量新增工作: ${newSchedule.jobName}`,
                  newSchedule.color
                );
              } else {
                showToast(
                  `已新增工作: ${newSchedule.jobName} (${formatDate(
                    dateKey
                  )} ${formatTime(newSchedule.start)}-${formatTime(
                    newSchedule.end
                  )})`,
                  newSchedule.color
                );
              }
              closeOverlapModal();
              updateSchedule();
              updateTotalHours();
            }
          } else if (action === "replaceAll") {
            for (let i = pendingIndex; i < pendingOverlaps.length; i++) {
              const { dateKey, overlap, newSchedule } = pendingOverlaps[i];
              removeOverlap(dateKey, overlap);
              addScheduleToStorage(dateKey, newSchedule, newSchedule.jobName);
            }
            if (isBatch) {
              pendingDatesToAdd.forEach(({ dateKey, newSchedule }) => {
                addScheduleToStorage(dateKey, newSchedule, newSchedule.jobName);
              });
              showToast(
                `已批量新增工作: ${pendingOverlaps[0].newSchedule.jobName}`,
                pendingOverlaps[0].newSchedule.color
              );
            } else {
              const { dateKey, newSchedule } = pendingOverlaps[pendingIndex];
              showToast(
                `已新增工作: ${newSchedule.jobName} (${formatDate(
                  dateKey
                )} ${formatTime(newSchedule.start)}-${formatTime(
                  newSchedule.end
                )})`,
                newSchedule.color
              );
            }
            closeOverlapModal();
            updateSchedule();
            updateTotalHours();
          } else {
            closeOverlapModal();
          }
        }

        function addScheduleToStorage(dateKey, newSchedule, jobName) {
          if (!Array.isArray(schedules[dateKey])) {
            schedules[dateKey] = [];
          }
          schedules[dateKey].push(newSchedule);
          localStorage.setItem("schedules", JSON.stringify(schedules));
          if (!jobNames.includes(jobName)) {
            jobNames.push(jobName);
            localStorage.setItem("jobNames", JSON.stringify(jobNames));
          }
        }

        function saveAddSchedule() {
          const jobName = document.getElementById("addJobName").value.trim();
          const jobDate = document.getElementById("addJobDate").value;
          const startTime =
            document.getElementById("addStartHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("addStartMinute").value.padStart(2, "0");
          const endTime =
            document.getElementById("addEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("addEndMinute").value.padStart(2, "0");
          const color = getColorForJob(jobName);
          const scheduleId = Date.now() + Math.random();

          const newSchedule = {
            id: scheduleId,
            jobName,
            start: startTime,
            end: endTime,
            color,
          };

          const dateKey = getLocalDateKey(new Date(jobDate));

          const overlaps = findOverlaps(dateKey, newSchedule);
          if (overlaps.length > 0) {
            isBatch = false;
            const overlapData = overlaps.map((overlap) => ({
              dateKey,
              overlap,
              newSchedule,
            }));
            showOverlapModal(overlapData, handleOverlapAction);
            return;
          }

          addScheduleToStorage(dateKey, newSchedule, jobName);
          closeAddModal();
          updateSchedule();
          updateTotalHours();
          showToast(
            `已新增工作: ${jobName} (${formatDate(jobDate)} ${formatTime(
              startTime
            )}-${formatTime(endTime)})`,
            color
          );
        }

        function saveBatchAddSchedule() {
          const jobName = document
            .getElementById("batchAddJobName")
            .value.trim();
          const startDateInput =
            document.getElementById("batchAddStartDate").value;
          const endDateInput = document.getElementById("batchAddEndDate").value;
          const startDate = new Date(startDateInput);
          const endDate = new Date(endDateInput);
          const startTime =
            document
              .getElementById("batchAddStartHour")
              .value.padStart(2, "0") +
            ":" +
            document
              .getElementById("batchAddStartMinute")
              .value.padStart(2, "0");
          const endTime =
            document.getElementById("batchAddEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("batchAddEndMinute").value.padStart(2, "0");
          const selectedDays = Array.from(
            document.querySelectorAll(".weekday.selected")
          ).map((el) => parseInt(el.dataset.day));
          const color = getColorForJob(jobName);

          if (endDate < startDate) {
            alert("結束日期不能早於開始日期。");
            return;
          }

          const datesToAdd = [];
          for (
            let date = new Date(startDate);
            date <= endDate;
            date.setDate(date.getDate() + 1)
          ) {
            if (selectedDays.includes(date.getDay())) {
              const dateKey = getLocalDateKey(new Date(date));
              const scheduleId = Date.now() + Math.random();

              const newSchedule = {
                id: scheduleId,
                jobName,
                start: startTime,
                end: endTime,
                color: color,
              };

              datesToAdd.push({ dateKey, newSchedule });
            }
          }

          handleBatchSchedules(datesToAdd, jobName, color);
          closeAddModal();
        }

        function handleBatchSchedules(datesToAdd, jobName, color) {
          let allOverlaps = [];
          let allNewSchedules = [];

          datesToAdd.forEach(({ dateKey, newSchedule }) => {
            const overlaps = findOverlaps(dateKey, newSchedule);
            if (overlaps.length > 0) {
              overlaps.forEach((overlap) => {
                allOverlaps.push({ dateKey, overlap, newSchedule });
              });
            } else {
              allNewSchedules.push({ dateKey, newSchedule });
            }
          });

          if (allOverlaps.length > 0) {
            isBatch = true;
            pendingOverlaps = allOverlaps;
            pendingIndex = 0;
            pendingAction = handleOverlapAction;
            pendingDatesToAdd = allNewSchedules;
            updateOverlapModal();
            overlapModal.style.display = "block";
          } else {
            allNewSchedules.forEach(({ dateKey, newSchedule }) => {
              addScheduleToStorage(dateKey, newSchedule, jobName);
            });
            updateSchedule();
            updateTotalHours();
            showToast(`已批量新增工作: ${jobName}`, color);
          }
        }

        function saveCommandSchedule() {
          const commandJobName = document
            .getElementById("commandJobName")
            .value.trim();
          const commandInputValue =
            document.getElementById("commandInput").value;
          const commands = commandInputValue
            .split("\n")
            .map((cmd) => cmd.trim())
            .filter((cmd) => cmd !== "");

          const jobName = commandJobName || "指令新增";
          const color = getColorForJob(jobName);

          const datesToAdd = [];

          commands.forEach((command) => {
            const parsedCommand = parseCommand(command);
            if (parsedCommand) {
              const { startDate, endDate, startTime, endTime, weekdays } =
                parsedCommand;

              for (
                let date = new Date(startDate);
                date <= endDate;
                date.setDate(date.getDate() + 1)
              ) {
                if (weekdays.length === 0 || weekdays.includes(date.getDay())) {
                  const dateKey = getLocalDateKey(new Date(date));
                  const scheduleId = Date.now() + Math.random();

                  const newSchedule = {
                    id: scheduleId,
                    jobName,
                    start: startTime,
                    end: endTime,
                    color: color,
                  };

                  datesToAdd.push({ dateKey, newSchedule });
                }
              }
            }
          });

          handleBatchSchedules(datesToAdd, jobName, color);
          closeAddModal();
        }

        function saveEditSchedule() {
          if (!currentEditKey) return;
          const { dateKey, scheduleId } = currentEditKey;

          const jobName = document.getElementById("editJobName").value.trim();
          const jobDate = document.getElementById("editJobDate").value;
          const startTime =
            document.getElementById("editStartHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("editStartMinute").value.padStart(2, "0");
          const endTime =
            document.getElementById("editEndHour").value.padStart(2, "0") +
            ":" +
            document.getElementById("editEndMinute").value.padStart(2, "0");
          const color = getColorForJob(jobName);

          const newDateKey = getLocalDateKey(new Date(jobDate));

          const newSchedule = {
            id: scheduleId,
            jobName,
            start: startTime,
            end: endTime,
            color,
          };

          const scheduleArray = schedules[dateKey];
          const scheduleIndex = scheduleArray.findIndex(
            (s) => s.id === scheduleId
          );
          if (scheduleIndex === -1) return;
          scheduleArray.splice(scheduleIndex, 1);
          if (scheduleArray.length === 0) {
            delete schedules[dateKey];
          }

          const overlaps = findOverlaps(newDateKey, newSchedule, scheduleId);
          if (overlaps.length > 0) {
            isBatch = false;
            const overlapData = overlaps.map((overlap) => ({
              dateKey: newDateKey,
              overlap,
              newSchedule,
            }));
            showOverlapModal(overlapData, handleOverlapAction);
            return;
          }

          addScheduleToStorage(newDateKey, newSchedule, jobName);
          closeEditModal();
          updateSchedule();
          updateTotalHours();
          showToast(
            `已修改工作: ${jobName} (${formatDate(jobDate)} ${formatTime(
              startTime
            )}-${formatTime(endTime)})`,
            color
          );
        }

        function parseCommand(command) {
          const commandRegex =
            /^(\d{1,2})\/(\d{1,2})(?:\s*[-~]\s*(\d{1,2})\/(\d{1,2}))?\s*([\d.:]{1,5})\s*[-~]\s*([\d.:]{1,5})(?:\s*[（(]([^）)]+)[)）])?$/;
          const match = command.match(commandRegex);

          if (!match) {
            console.error(`指令格式不正確: ${command}`);
            return null;
          }

          const startMonth = parseInt(match[1], 10);
          const startDay = parseInt(match[2], 10);
          const endMonth = match[3] ? parseInt(match[3], 10) : startMonth;
          const endDay = match[4] ? parseInt(match[4], 10) : startDay;
          const startTimeStr = match[5];
          const endTimeStr = match[6];
          const weekdaysStr = match[7] || "";

          const weekdays = weekdaysStr
            ? weekdaysStr
                .split(/[、,]/)
                .map((day) => "日一二三四五六".indexOf(day.trim()))
                .filter((day) => day !== -1)
            : [];

          const currentYear = new Date().getFullYear();

          const startDate = new Date(currentYear, startMonth - 1, startDay);
          const endDate = new Date(currentYear, endMonth - 1, endDay);

          const startTime = convertTime(startTimeStr);
          const endTime = convertTime(endTimeStr);

          if (!startTime || !endTime) {
            console.error(`無法解析時間: ${startTimeStr} 或 ${endTimeStr}`);
            return null;
          }

          return {
            startDate,
            endDate,
            startTime,
            endTime,
            weekdays,
          };
        }

        function convertTime(timeStr) {
          if (timeStr.includes(":")) {
            const [hoursStr, minutesStr] = timeStr.split(":");
            const hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr, 10);
            if (isNaN(hours) || isNaN(minutes)) {
              console.error(`無效的時間格式: ${timeStr}`);
              return null;
            }
            return `${String(hours).padStart(2, "0")}:${String(
              minutes
            ).padStart(2, "0")}`;
          } else if (timeStr.includes(".")) {
            const parts = timeStr.split(".");
            const hours = parseInt(parts[0], 10);
            let minutes = "00";
            if (parts[1]) {
              if (parts[1].length === 1) {
                if (parts[1] === "5") {
                  minutes = "30";
                } else {
                  minutes = `${parts[1]}0`;
                }
              } else if (parts[1].length === 2) {
                minutes = parts[1].padStart(2, "0");
              }
            }
            if (isNaN(hours) || isNaN(parseInt(minutes, 10))) {
              console.error(`無效的時間格式: ${timeStr}`);
              return null;
            }
            return `${String(hours).padStart(2, "0")}:${minutes}`;
          } else {
            const hours = parseInt(timeStr, 10);
            if (isNaN(hours)) {
              console.error(`無效的時間格式: ${timeStr}`);
              return null;
            }
            return `${String(hours).padStart(2, "0")}:00`;
          }
        }

        function toggleWeekdaySelection(event) {
          event.target.classList.toggle("selected");
        }

        function autocomplete(inp, arr) {
          let currentFocus;
          inp.addEventListener("input", function (e) {
            let a,
              b,
              i,
              val = this.value;
            closeAllLists();
            if (!val) {
              return false;
            }
            currentFocus = -1;
            a = document.createElement("DIV");
            a.setAttribute("id", this.id + "autocomplete-list");
            a.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(a);
            for (i = 0; i < arr.length; i++) {
              if (
                arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()
              ) {
                b = document.createElement("DIV");
                b.innerHTML =
                  "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                b.innerHTML += arr[i].substr(val.length);
                b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                b.addEventListener("click", function (e) {
                  inp.value = this.getElementsByTagName("input")[0].value;
                  closeAllLists();
                });
                a.appendChild(b);
              }
            }
          });
          inp.addEventListener("keydown", function (e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) {
              currentFocus++;
              addActive(x);
            } else if (e.keyCode == 38) {
              currentFocus--;
              addActive(x);
            } else if (e.keyCode == 13) {
              e.preventDefault();
              if (currentFocus > -1) {
                if (x) x[currentFocus].click();
              }
            }
          });
          function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = x.length - 1;
            x[currentFocus].classList.add("autocomplete-active");
          }
          function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
              x[i].classList.remove("autocomplete-active");
            }
          }
          function closeAllLists(elmnt) {
            let x = document.getElementsByClassName("autocomplete-items");
            for (let i = 0; i < x.length; i++) {
              if (elmnt != x[i] && elmnt != inp) {
                x[i].parentNode.removeChild(x[i]);
              }
            }
          }
          document.addEventListener("click", function (e) {
            closeAllLists(e.target);
          });
        }

        function toggleAddMode(selectedMode) {
          singleAddToggle.classList.remove("active");
          batchAddToggle.classList.remove("active");
          commandToggle.classList.remove("active");

          singleAddContainer.style.display = "none";
          batchAddContainer.style.display = "none";
          commandContainer.style.display = "none";

          if (selectedMode === "single") {
            singleAddToggle.classList.add("active");
            singleAddContainer.style.display = "block";
          } else if (selectedMode === "multi") {
            batchAddToggle.classList.add("active");
            batchAddContainer.style.display = "block";
          } else if (selectedMode === "command") {
            commandToggle.classList.add("active");
            commandContainer.style.display = "block";
          }
        }

        addButton.addEventListener("click", () => {
          openAddModal();
        });

        closeAddBtn.addEventListener("click", closeAddModal);
        closeEditBtn.addEventListener("click", closeEditModal);
        closeViewDayBtn.addEventListener("click", closeViewDayModal);

        window.addEventListener("click", (event) => {
          if (event.target == modalAdd) {
            closeAddModal();
          }
          if (event.target == modalEdit) {
            closeEditModal();
          }
          if (event.target == modalViewDay) {
            closeViewDayModal();
          }
        });

        singleAddToggle.addEventListener("click", () => {
          toggleAddMode("single");
        });

        batchAddToggle.addEventListener("click", () => {
          toggleAddMode("multi");
        });

        commandToggle.addEventListener("click", () => {
          toggleAddMode("command");
        });

        prevWeekBtn.addEventListener("click", () => updateWeek(-1));
        nextWeekBtn.addEventListener("click", () => updateWeek(1));

        addForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveAddSchedule();
        });

        batchAddForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveBatchAddSchedule();
        });

        commandForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveCommandSchedule();
        });

        editForm.addEventListener("submit", (e) => {
          e.preventDefault();
          saveEditSchedule();
        });

        function updateTimeScale() {
          const timeScale = document.querySelector(".time-scale");
          timeScale.innerHTML = "";

          for (let i = 7; i <= 23; i++) {
            const timeSlot = document.createElement("div");
            timeSlot.classList.add("time-slot");
            timeSlot.innerHTML = `${
              i < 12 ? "早上" : i < 18 ? "下午" : "晚上"
            } ${i % 12 || 12}:00`;
            timeScale.appendChild(timeSlot);
          }
        }

        function populateTimeOptions() {
          const hours = [...Array(24).keys()].map((i) =>
            String(i).padStart(2, "0")
          );
          const minutes = [];
          for (let i = 0; i < 60; i += 5) {
            minutes.push(String(i).padStart(2, "0"));
          }

          function addOptions(select, options) {
            select.innerHTML = "";
            options.forEach((option) => {
              const opt = document.createElement("option");
              opt.value = option;
              opt.textContent = option;
              select.appendChild(opt);
            });
          }

          [
            "addStartHour",
            "addEndHour",
            "editStartHour",
            "editEndHour",
            "batchAddStartHour",
            "batchAddEndHour",
          ].forEach((id) => {
            addOptions(document.getElementById(id), hours);
          });

          [
            "addStartMinute",
            "addEndMinute",
            "editStartMinute",
            "editEndMinute",
            "batchAddStartMinute",
            "batchAddEndMinute",
          ].forEach((id) => {
            addOptions(document.getElementById(id), minutes);
          });
        }

        function resetAddForms() {
          addForm.reset();
          batchAddForm.reset();
          commandForm.reset();
          document.querySelectorAll(".weekday").forEach((day) => {
            day.classList.remove("selected");
          });
          toggleAddMode("single");
        }

        function showToast(message, color) {
          toast.textContent = message;
          toast.style.backgroundColor = color || "#ff1493";
          toast.className = "toast show";
          setTimeout(() => {
            toast.className = toast.className.replace("show", "");
            toast.style.backgroundColor = "";
          }, 3000);
        }

        generateWeekGrid();
        updateDates();
        updateTimeScale();
        requestAnimationFrame(() => {
          updateSchedule();
          updateTotalHours();
        });
        autocomplete(jobNameInputAdd, jobNames);
        autocomplete(jobNameInputBatchAdd, jobNames);
        autocomplete(jobNameInputEdit, jobNames);
        autocomplete(commandJobNameInput, jobNames);
        populateTimeOptions();

        document.querySelectorAll(".weekday").forEach((day) => {
          day.addEventListener("click", toggleWeekdaySelection);
        });

        let lastTouchEnd = 0;
        document.addEventListener(
          "touchend",
          function (event) {
            let now = new Date().getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          },
          false
        );
      });

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      }
    </script>
  </body>
</html>
